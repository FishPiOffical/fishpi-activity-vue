<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>å¾½ç« å…±åˆ›è®¡åˆ’</title>
    <!-- Umami Analytics -->
    <script defer src="https://umami.aweoo.com/script.js" data-website-id="026abece-76c0-4781-8422-5e0b70b5a3b3"></script>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #e5d7d6;
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }
        .container { max-width: 1200px; margin: 0 auto; }
        /* å¯¼èˆªæ  */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #d6a2ad;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(214, 162, 173, 0.35);
            z-index: 999;
            padding: 12px 20px;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .nav-logo {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.15);
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
        }
        .nav-link.active {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.3);
        }
        /* å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯ */
        .nav-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        .nav-user-loading {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }
        .nav-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            object-fit: cover;
            transition: all 0.3s;
        }
        .nav-user-avatar:hover {
            border-color: white;
            transform: scale(1.05);
        }
        .nav-user-name {
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .nav-user-btn {
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .nav-user-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }
        .nav-login-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .nav-login-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            border-color: white;
        }
        /* å›åˆ°é¡¶éƒ¨æŒ‰é’® */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #d6a2ad;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(214, 162, 173, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 998;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        .back-to-top:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(214, 162, 173, 0.6);
            background: #ecb8c0;
        }
        .back-to-top:active {
            transform: translateY(-2px);
        }
        /* å¤´éƒ¨ */
        header {
            background: white; border-radius: 12px; padding: 30px; margin-bottom: 30px;
            box-shadow: 0 4px 25px rgba(214, 162, 173, 0.2); text-align: center;
        }
        header h1 { font-size: 2.5rem; color: #2c2c2c; margin-bottom: 10px; }
        header p { color: #555; font-size: 1.1rem; }
        /* activityDesc ä¸­çš„é“¾æ¥æ ·å¼ */
        #activityDesc a {
            color: #9a8398;
            text-decoration: none;
            font-weight: 500;
            background: rgba(214, 162, 173, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            border-bottom: 2px solid rgba(154, 131, 152, 0.3);
        }
        #activityDesc a:hover {
            color: #fff;
            background: #d6a2ad;
            border-bottom-color: #d6a2ad;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(214, 162, 173, 0.3);
        }
        .activity-time {
            margin-top: 15px;
            padding: 12px 20px;
            background: rgba(214, 162, 173, 0.12);
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(214, 162, 173, 0.15);
            border: 1px solid rgba(214, 162, 173, 0.2);
        }
        .time-label {
            color: #9a8398;
            font-weight: 600;
            font-size: 1rem;
        }
        .time-value {
            color: #d6a2ad;
            font-weight: 500;
            font-size: 1rem;
        }
        /* ç™»å½•æç¤º */
        .login-prompt {
            background: rgba(214, 162, 173, 0.12);
            border: 2px solid #d6a2ad;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(214, 162, 173, 0.2);
            animation: pulse-border 2s ease-in-out infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #d6a2ad; }
            50% { border-color: #ecb8c0; }
        }
        .login-prompt p {
            color: #9a8398;
            font-size: 1.15rem;
            font-weight: 700;
            margin: 0 0 15px 0;
            line-height: 1.6;
        }
        .login-prompt-btn {
            display: inline-block;
            background: #d6a2ad;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 700;
            border: 2px solid #d6a2ad;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(214, 162, 173, 0.4);
        }
        .login-prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(214, 162, 173, 0.5);
            background: #ecb8c0;
            border-color: #ecb8c0;
        }
        .login-prompt-btn:active {
            transform: translateY(0);
        }
        /* æ´»åŠ¨åŒºå— */
        .activity-section {
            background: white; border-radius: 12px; padding: 30px; margin-bottom: 30px;
            box-shadow: 0 4px 25px rgba(214, 162, 173, 0.2);
        }
        .activity-section h2 {
            color: #2c2c2c; font-size: 1.8rem; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 3px solid #d6a2ad;
        }
        .activity-section p { color: #555; line-height: 1.8; margin-bottom: 15px; }
        /* æ´»åŠ¨æè¿°ï¼ˆæ”¯æŒrich editor HTMLæ ¼å¼ï¼‰*/
        .activity-desc { color: #555; line-height: 1.8; margin-bottom: 15px; }
        .activity-desc p { margin-bottom: 10px; }
        .activity-desc ul, .activity-desc ol { margin-left: 20px; margin-bottom: 10px; }
        .activity-desc li { margin-bottom: 5px; }
        .activity-desc strong { font-weight: 600; }
        .activity-desc em { font-style: italic; }
        .activity-desc a {
            color: #9a8398;
            text-decoration: none;
            font-weight: 500;
            background: rgba(214, 162, 173, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            border-bottom: 2px solid rgba(154, 131, 152, 0.3);
        }
        .activity-desc a:hover {
            color: #fff;
            background: #d6a2ad;
            border-bottom-color: #d6a2ad;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(214, 162, 173, 0.3);
        }
        .activity-desc blockquote {
            border-left: 4px solid #d6a2ad;
            padding-left: 15px;
            margin: 10px 0;
            color: #555;
            font-style: italic;
            background: rgba(214, 162, 173, 0.05);
        }
        .activity-desc code {
            background: rgba(214, 162, 173, 0.15);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #9a8398;
        }
        .activity-desc pre {
            background: rgba(214, 162, 173, 0.15);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid rgba(214, 162, 173, 0.3);
        }
        /* è¡¨å• */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c2c2c; }
        .form-group label .required { color: #dc3545; margin-left: 4px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 1rem; font-family: inherit; transition: border-color 0.3s;
        }
        .form-group input.error, .form-group textarea.error {
            border-color: #dc3545; background-color: #fff5f5;
        }
        .form-group .error-message { color: #dc3545; font-size: 0.875rem; margin-top: 4px; display: none; }
        .form-group .error-message.show { display: block; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group input[type="color"] { height: 50px; cursor: pointer; }
        .color-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        /* å¾½ç« é¢„è§ˆ */
        .shield-preview { margin: 20px 0; padding: 20px; background: rgba(214, 162, 173, 0.08); border-radius: 8px; text-align: center; border: 1px solid rgba(214, 162, 173, 0.2); }
        .shield-preview img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .shield-preview img:hover {
            transform: scale(1.05);
        }
        /* æŠ˜å åŒºå— */
        .collapsible-section { margin: 20px 0; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .collapsible-header {
            background: white; padding: 12px 15px; cursor: pointer; user-select: none;
            display: flex; justify-content: space-between; align-items: center; transition: background 0.3s;
        }
        .collapsible-header:hover { background: rgba(214, 162, 173, 0.1); }
        .collapsible-header .toggle-icon { font-weight: bold; transition: transform 0.3s; }
        .collapsible-header.active .toggle-icon { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible-content.active { max-height: 2000px; padding: 15px; }
        /* æŒ‰é’® */
        .btn { background: #d6a2ad; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 1rem; cursor: pointer; transition: all 0.3s; margin-right: 10px; font-weight: 600; box-shadow: 0 2px 8px rgba(214, 162, 173, 0.3); }
        .btn:hover { background: #ecb8c0; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(214, 162, 173, 0.4); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-cancel { background: #6c757d; }
        .btn-cancel:hover { background: #5a6268; }
        /* æŠ•ç¥¨åŒºå— */
        .vote-section { margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee; }
        .vote-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .vote-item {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }
        .vote-item:hover { border-color: #d6a2ad; box-shadow: 0 5px 15px rgba(214, 162, 173, 0.25); transform: translateY(-2px); }
        .vote-item.voted { border-color: #4CAF50; box-shadow: 0 2px 10px rgba(76, 175, 80, 0.2); }
        .vote-item.my-submission { border-color: #ff9800; box-shadow: 0 2px 10px rgba(255, 152, 0, 0.2); }
        .vote-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .vote-item-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .vote-item-avatar:hover {
            border-color: #d6a2ad;
            transform: scale(1.1);
        }
        .vote-item-name {
            font-weight: 500;
            color: #555;
            font-size: 0.875rem;
            flex: 1;
            cursor: pointer;
            transition: color 0.2s;
        }
        .vote-item-name:hover {
            color: #d6a2ad;
            text-decoration: underline;
        }
        .vote-item-keyword {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c2c2c;
            margin: 12px 0 15px 0;
            line-height: 1.3;
            word-break: break-word;
            text-align: center;
        }
        .vote-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .vote-item-description {
            color: #444;
            line-height: 1.6;
            font-size: 0.95rem;
            margin-bottom: 8px;
            word-break: break-word;
            white-space: pre-wrap;
            position: relative;
            max-height: 4.8em; /* å›ºå®šæ˜¾ç¤ºçº¦3è¡Œ */
            overflow: hidden;
        }
        .vote-item-description::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2em;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1));
            pointer-events: none;
        }
        .vote-item-description.short {
            max-height: none; /* çŸ­æ–‡æœ¬ä¸é™åˆ¶é«˜åº¦ */
        }
        .vote-item-description.short::after {
            display: none; /* çŸ­æ–‡æœ¬ä¸æ˜¾ç¤ºæ¸å˜ */
        }
        .view-full-btn {
            color: #9a8398;
            font-size: 0.85rem;
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            background: rgba(154, 131, 152, 0.08);
            border: 1px solid rgba(154, 131, 152, 0.15);
            margin-bottom: 8px;
        }
        .view-full-btn:hover {
            background: rgba(154, 131, 152, 0.15);
            color: #d6a2ad;
            transform: translateY(-1px);
        }
        .view-full-btn:active {
            transform: translateY(0);
        }
        .vote-item-shield {
            margin: 12px 0;
            text-align: center;
            position: relative;
        }
        .vote-item-shield img {
            max-width: 100%;
            height: auto;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            border-radius: 6px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(154, 131, 152, 0.15);
        }
        .vote-item-shield img:hover {
            transform: scale(1.08);
            border-color: #d6a2ad;
            box-shadow: 0 4px 16px rgba(214, 162, 173, 0.4);
        }
        /* å¾½ç« å›¾æ ‡æŒ‡ç¤ºå™¨ */
        .vote-item-shield::before {
            content: 'ğŸ‘ï¸';
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(154, 131, 152, 0.95);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0.8;
            transition: all 0.3s;
            z-index: 5;
            pointer-events: none;
            animation: badgePulse 2s ease-in-out infinite;
        }
        .vote-item-shield:hover::before {
            opacity: 1;
            transform: scale(1.15);
            animation: none;
        }
        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }
        /* å¾½ç« æ‚¬åœæç¤º */
        .vote-item-shield::after {
            content: 'ç‚¹å‡»é¢„è§ˆ';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(214, 162, 173, 0.95);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(154, 131, 152, 0.3);
        }
        .vote-item-shield:hover::after {
            opacity: 1;
            bottom: -32px;
        }
        .vote-item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        .vote-count { color: #9a8398; font-weight: 600; cursor: pointer; text-decoration: underline; }
        .vote-count:hover { color: #d6a2ad; }
        .error { background: #ffebee; color: #c62828; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ef5350; }
        /* æ’åºå’Œç¥¨æ•°ä¿¡æ¯ */
        .sort-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .sort-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .sort-btn { background: white; color: #333; border: 1px solid #ddd; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .sort-btn:hover { background: rgba(214, 162, 173, 0.1); border-color: #d6a2ad; }
        .sort-btn.active { background: #d6a2ad; color: white; border-color: #d6a2ad; box-shadow: 0 2px 8px rgba(214, 162, 173, 0.3); }
        .vote-info { background: rgba(214, 162, 173, 0.12); padding: 10px 15px; border-radius: 6px; color: #9a8398; font-weight: 600; border: 1px solid #ecb8c0; }
        .vote-quota-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(214, 162, 173, 0.12);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(214, 162, 173, 0.15);
            border: 1px solid rgba(214, 162, 173, 0.2);
        }
        .vote-quota-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .vote-quota-label {
            color: #9a8398;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .vote-quota-value {
            color: #d6a2ad;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .vote-quota-remaining {
            color: #2e7d32;
        }
        .vote-quota-used {
            color: #f57c00;
        }
        .vote-quota-separator {
            color: #ecb8c0;
            font-weight: 300;
        }
        /* æŠ•ç¥¨è¯¦æƒ…æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: #333; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .modal-close:hover { color: #333; }
        .voter-list { list-style: none; padding: 0; }
        .voter-item { padding: 15px; border-bottom: 1px solid #eee; }
        .voter-item:last-child { border-bottom: none; }
        .voter-item.invalid-vote { background-color: #f9f9f9; opacity: 0.7; }
        .voter-header { display: flex; align-items: center; margin-bottom: 8px; }
        .voter-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        .voter-info { display: flex; flex-direction: column; flex: 1; }
        .voter-name-line { display: flex; align-items: center; gap: 6px; }
        .voter-name { color: #333; font-weight: 600; }
        .voter-time { color: #999; font-size: 0.75rem; margin-top: 2px; }
        .recent-user-badge {
            display: inline-block;
            background-color: #ff9800;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: normal;
            white-space: nowrap;
        }
        .voter-comment {
            background: rgba(214, 162, 173, 0.08);
            padding: 10px;
            border-radius: 6px;
            color: #555;
            line-height: 1.6;
            margin-left: 40px;
            font-size: 0.9rem;
            border: 1px solid rgba(214, 162, 173, 0.15);
        }
        /* å¾½ç« é¢„è§ˆå¼¹çª— */
        .badge-preview-modal-content {
            max-width: 500px;
        }
        .badge-preview-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .badge-preview-avatar {
            max-width: 210px;
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .badge-preview-nickname {
            font-size: 26px;
            line-height: 30px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            text-align: center;
        }
        .badge-preview-name {
            font-size: 20px;
            font-weight: 300;
            line-height: 26px;
            color: #787777;
            margin-bottom: 20px;
            text-align: center;
        }
        .badge-preview-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            width: 100%;
        }
        .badge-preview-badges img {
            max-width: 150px;
            height: auto;
            cursor: default;
            transition: transform 0.2s;
        }
        .badge-preview-badges img:hover {
            transform: scale(1.05);
        }
        /* å¾½ç« é¢„è§ˆåˆ†å‰²çº¿ */
        .badge-preview-divider {
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #d6a2ad, transparent);
            margin: 30px 0 20px 0;
            position: relative;
        }
        .badge-preview-divider::before {
            content: '3å€ç¼©æ”¾é¢„è§ˆ';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 15px;
            color: #9a8398;
            font-size: 0.85rem;
            font-weight: 600;
        }
        /* 3å€ç¼©æ”¾å¾½ç« åŒºåŸŸ */
        .badge-preview-scaled {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            width: 100%;
            padding: 20px;
            background: rgba(214, 162, 173, 0.05);
            border-radius: 8px;
        }
        .badge-preview-scaled img {
            max-width: 100%;
            height: auto;
            cursor: default;
            box-shadow: 0 2px 10px rgba(154, 131, 152, 0.2);
            border-radius: 4px;
        }
        /* å†…å®¹è¯¦æƒ…æ¨¡æ€æ¡† */
        .content-detail-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .content-detail-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .content-detail-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(154, 131, 152, 0.3);
        }
        .content-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(214, 162, 173, 0.2);
        }
        .content-detail-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #9a8398;
            margin: 0;
            flex: 1;
        }
        .content-detail-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .content-detail-close:hover {
            background: rgba(214, 162, 173, 0.1);
            color: #d6a2ad;
        }
        .content-detail-body {
            color: #444;
            line-height: 1.8;
            font-size: 1rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .content-detail-author {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(214, 162, 173, 0.08);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .content-detail-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(214, 162, 173, 0.3);
        }
        .content-detail-author-info {
            flex: 1;
        }
        .content-detail-author-name {
            font-weight: 600;
            color: #9a8398;
            font-size: 1rem;
        }
        .content-detail-author-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 2px;
        }
        /* ç¼–è¾‘æŒ‰é’® */
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-small { padding: 6px 12px; font-size: 0.875rem; }
        /* å¥–åŠ±å±•ç¤º */
        .rewards-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            border: 2px solid #ecb8c0;
        }
        .rewards-section h3 {
            color: #495057;
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
        }
        .rewards-section h3:hover {
            color: #9a8398;
        }
        .rewards-toggle-icon {
            margin-left: auto;
            transition: transform 0.3s;
            font-size: 0.9rem;
            color: #868e96;
        }
        .rewards-toggle-icon.expanded {
            transform: rotate(180deg);
        }
        .rewards-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .rewards-list.collapsed {
            display: block;
        }
        .rewards-list.collapsed .reward-item:not(:first-child) {
            display: none;
        }
        .reward-item {
            background: white;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #f5d2d6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .reward-item:hover {
            border-color: #d6a2ad;
            box-shadow: 0 2px 12px rgba(214, 162, 173, 0.2);
            transform: translateX(5px);
        }
        .reward-rank {
            font-weight: 600;
            color: #9a8398;
            font-size: 0.95rem;
            min-width: 100px;
        }
        .reward-details {
            flex: 1;
            padding: 0 12px;
        }
        .reward-name {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }
        .reward-point {
            font-weight: 600;
            color: #28a745;
            font-size: 1rem;
            white-space: nowrap;
        }
        /* ç”¨æˆ·æŠ•ç¨¿å±•ç¤º */
        .my-submission-display {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
        }
        .my-submission-display h4 {
            color: #ff9800;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 152, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }
        .my-submission-display .submission-content {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }
        .my-submission-display .submission-title {
            font-weight: 700;
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.3;
            word-break: break-word;
        }
        .my-submission-display .submission-text {
            color: #555;
            line-height: 1.6;
            font-size: 0.95rem;
            word-break: break-word;
            white-space: pre-wrap;
        }
        .my-submission-display .submission-shield {
            margin: 12px 0;
            text-align: center;
        }
        .my-submission-display .submission-shield img {
            max-width: 100%;
            height: auto;
        }
        /* å†å¹´å›é¡¾æ ·å¼ */
        .histories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .history-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 25px rgba(214, 162, 173, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(214, 162, 173, 0.15);
        }
        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 30px rgba(214, 162, 173, 0.3);
        }
        .history-year {
            font-size: 2rem;
            font-weight: bold;
            color: #9a8398;
            margin-bottom: 15px;
            text-align: center;
        }
        .history-keyword {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(214, 162, 173, 0.1);
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(214, 162, 173, 0.2);
        }
        .history-shields {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .history-shield-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .history-shield-item img {
            max-width: 150px;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .history-shield-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        .history-article-link {
            display: block;
            text-align: center;
            padding: 10px;
            background: #d6a2ad;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(214, 162, 173, 0.3);
        }
        .history-article-link:hover {
            background: #ecb8c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(214, 162, 173, 0.4);
        }
        /* æ´»åŠ¨æœªå¼€å§‹è’™ç‰ˆ */
        .activity-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(229, 215, 214, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .overlay-content {
            background: white;
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(154, 131, 152, 0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 3px solid #d6a2ad;
        }
        .overlay-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .overlay-title {
            font-size: 2rem;
            font-weight: 700;
            color: #9a8398;
            margin-bottom: 15px;
        }
        .overlay-message {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .countdown-container {
            background: rgba(214, 162, 173, 0.1);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #d6a2ad;
        }
        .countdown-label {
            font-size: 1rem;
            color: #9a8398;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .countdown-item {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(214, 162, 173, 0.2);
            min-width: 80px;
        }
        .countdown-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #d6a2ad;
            display: block;
            line-height: 1;
        }
        .countdown-unit {
            font-size: 0.9rem;
            color: #9a8398;
            margin-top: 5px;
            display: block;
        }
        .overlay-start-time {
            color: #d6a2ad;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 15px;
        }
        .overlay-back-btn {
            display: inline-block;
            background: #d6a2ad;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(214, 162, 173, 0.3);
            margin: 0 8px;
        }
        .overlay-back-btn:hover {
            background: #ecb8c0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(214, 162, 173, 0.4);
        }
        .overlay-preview-btn {
            display: inline-block;
            background: #9a8398;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(154, 131, 152, 0.3);
            margin: 0 8px;
        }
        .overlay-preview-btn:hover {
            background: #b5a3b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(154, 131, 152, 0.4);
        }
        .overlay-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            body { padding-top: 140px; } /* ç§»åŠ¨ç«¯å¯¼èˆªæ å¯èƒ½æ¢è¡Œï¼Œéœ€è¦æ›´å¤šç©ºé—´ */
            header h1 { font-size: 1.8rem; }
            .color-input-group { grid-template-columns: 1fr; }
            .vote-list { grid-template-columns: 1fr; }
            .vote-item-keyword { font-size: 1.3rem; }
            .vote-item { padding: 10px; }
            .my-submission-display .submission-title { font-size: 1.3rem; }
            .nav-container {
                justify-content: center;
                flex-direction: column;
                gap: 12px;
            }
            .nav-logo { font-size: 1rem; }
            .nav-links {
                gap: 8px;
                justify-content: center;
            }
            .nav-link {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            .nav-user-info {
                width: 100%;
                justify-content: center;
                margin-left: 0;
            }
            .nav-user-name {
                max-width: 100px;
            }
            .back-to-top {
                width: 45px;
                height: 45px;
                bottom: 20px;
                right: 20px;
                font-size: 1.3rem;
            }
            .login-prompt {
                padding: 20px 15px;
            }
            .login-prompt p {
                font-size: 1rem;
            }
            .login-prompt-btn {
                font-size: 1rem;
                padding: 10px 25px;
            }
            .activity-time {
                margin-top: 12px;
                padding: 10px 15px;
            }
            .time-label, .time-value {
                font-size: 0.9rem;
                display: block;
            }
            .time-value {
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- æ´»åŠ¨æœªå¼€å§‹è’™ç‰ˆ -->
    <div class="activity-overlay" id="activityOverlay" style="display: none;">
        <div class="overlay-content">
            <div class="overlay-icon">â°</div>
            <div class="overlay-title">æ´»åŠ¨å³å°†å¼€å§‹</div>
            <div class="overlay-message">æ´»åŠ¨å°šæœªå¼€å§‹ï¼Œæ•¬è¯·æœŸå¾…ï¼æ‚¨å¯ä»¥å…ˆæµè§ˆæ´»åŠ¨è¯¦æƒ…ã€‚</div>
            <div class="countdown-container">
                <div class="countdown-label">è·ç¦»æ´»åŠ¨å¼€å§‹è¿˜æœ‰</div>
                <div class="countdown-timer" id="countdownTimer"></div>
            </div>
            <div class="overlay-start-time" id="overlayStartTime"></div>
            <div class="overlay-buttons">
                <button class="overlay-preview-btn" onclick="hideOverlay()">ğŸ‘€ æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…</button>
                <button class="overlay-back-btn" onclick="window.location.href='/index.html'">è¿”å›æ´»åŠ¨åˆ—è¡¨</button>
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="nav-bar">
        <div class="nav-container">
            <a href="#" class="nav-logo" onclick="scrollToTop(); return false;">
                ğŸ‰ å¾½ç« å…±åˆ›è®¡åˆ’
            </a>
            <div class="nav-links">
                <a href="#activity1" class="nav-link" data-section="activity1">ğŸ“ æ´»åŠ¨ä¸€</a>
                <a href="#activity2" class="nav-link" data-section="activity2">ğŸ¨ æ´»åŠ¨äºŒ</a>
                <a href="#activity3" class="nav-link" data-section="activity3">ğŸ† æ´»åŠ¨ä¸‰</a>
                <a href="#yearlyHistories" class="nav-link" data-section="yearlyHistories">ğŸ“œ å†å¹´å›é¡¾</a>
            </div>
            <div class="nav-user-info" id="navUserInfo">
                <span class="nav-user-loading">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </nav>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()" title="å›åˆ°é¡¶éƒ¨">
        â†‘
    </button>

    <div class="container">
        <header>
            <h1 id="activityTitle">ğŸ‰ æ‘¸é±¼æ´¾ç¬¬äº”å±Šå¾½ç« å…±åˆ›è®¡åˆ’</h1>
            <p id="activityDesc">æ„Ÿè°¢é™ªä¼´ï¼Œè®©æˆ‘ä»¬ä¸€èµ·åº†ç¥æ‘¸é±¼æ´¾äº”å‘¨å²ç”Ÿæ—¥ï¼</p>
            <div class="activity-time" id="activityTime" style="display: none;">
                <span class="time-label">â° æ´»åŠ¨æ—¶é—´ï¼š</span>
                <span class="time-value" id="activityTimeValue">åŠ è½½ä¸­...</span>
            </div>
        </header>
        <div id="loginPrompt" class="login-prompt" style="display: none;">
            <p>ğŸ’¡ è¯·å…ˆç™»å½•åå‚ä¸æ´»åŠ¨è®¾è®¡å’ŒæŠ•ç¥¨ï¼Œæœªç™»å½•ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æŠ•ç¥¨ç»“æœ</p>
            <a href="#" onclick="redirectToLogin(); return false;" class="login-prompt-btn">ğŸš€ ç«‹å³ç™»å½•</a>
        </div>
        <!-- æ´»åŠ¨ä¸€ï¼šäº”å‘¨å¹´å…³é”®è¯ -->
        <div class="activity-section" id="activity1">
            <h2 class="activity-title">ğŸ“ æ´»åŠ¨ä¸€ï¼šäº”å‘¨å¹´å…³é”®è¯</h2>
            <div class="activity-desc"><p>ç”¨ä¸€ä¸ªå…³é”®è¯å®šä¹‰æ‘¸é±¼æ´¾çš„è¿™äº”å¹´ï¼å‘è¡¨æ–‡ç« ï¼Œæ ‡é¢˜ä¸ºæ‚¨çš„å…³é”®è¯ï¼Œå†…å®¹ä¸ºå…³é”®è¯ä»‹ç»ã€‚</p></div>
            <div id="activity1Rewards"></div>
            <div id="activity1Submission" style="display: none;"></div>
            <div id="activity1Form" style="display: none;">
                <div class="form-group">
                    <label for="keyword">å…³é”®è¯ <span class="required">*</span></label>
                    <input type="text" id="keyword" placeholder="è¯·è¾“å…¥ä¸€ä¸ªèƒ½ä»£è¡¨æ‘¸é±¼æ´¾äº”å¹´çš„å…³é”®è¯" maxlength="50" required>
                    <div class="error-message" id="keywordError">è¯·è¾“å…¥å…³é”®è¯</div>
                </div>
                <div class="form-group">
                    <label for="keywordDesc">å…³é”®è¯ä»‹ç» <span class="required">*</span></label>
                    <textarea id="keywordDesc" placeholder="è¯·ä»‹ç»è¿™ä¸ªå…³é”®è¯çš„å«ä¹‰ä»¥åŠä¸ºä»€ä¹ˆé€‰æ‹©å®ƒ..." required></textarea>
                    <div class="error-message" id="keywordDescError">è¯·è¾“å…¥å…³é”®è¯ä»‹ç»</div>
                </div>
                <button class="btn" onclick="submitKeyword()">æäº¤å…³é”®è¯</button>
                <button class="btn btn-cancel" onclick="cancelEdit('keyword')" style="display: none;" id="cancelKeywordBtn">å–æ¶ˆç¼–è¾‘</button>
            </div>
            <div class="vote-section">
                <h3>æŠ•ç¥¨ä¸æŸ¥çœ‹</h3>
                <div id="activity1Votes" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        <!-- æ´»åŠ¨äºŒï¼š2025æµè¡Œè‰² -->
        <div class="activity-section" id="activity2">
            <h2 class="activity-title">ğŸ¨ æ´»åŠ¨äºŒï¼š2025æµè¡Œè‰²</h2>
            <div class="activity-desc"><p>ä¸º"2025å¾½ç« "è®¾è®¡æ‚¨å¿ƒç›®ä¸­çš„æµè¡Œé…è‰²æ–¹æ¡ˆï¼</p></div>
            <div id="activity2Rewards"></div>
            <div id="activity2Submission" style="display: none;"></div>
            <div id="activity2Form" style="display: none;">
                <div class="form-group">
                    <label for="badge2025Title">è®¾è®¡æ ‡é¢˜ <span class="required">*</span></label>
                    <input type="text" id="badge2025Title" placeholder="ç»™æ‚¨çš„é…è‰²æ–¹æ¡ˆèµ·ä¸ªåå­—" maxlength="50" required>
                    <div class="error-message" id="badge2025TitleError">è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜</div>
                </div>
                <div class="form-group">
                    <label for="badge2025Note">è®¾è®¡æ€è·¯</label>
                    <textarea id="badge2025Note" placeholder="ä»‹ç»ä¸€ä¸‹æ‚¨çš„è®¾è®¡æ€è·¯å’Œé…è‰²ç†å¿µ..." rows="3"></textarea>
                </div>
                <div class="color-input-group">
                    <div class="form-group">
                        <label for="badge2025Back">èƒŒæ™¯è‰² <span class="required">*</span></label>
                        <input type="color" id="badge2025Back" value="#db5a6b" required>
                    </div>
                    <div class="form-group">
                        <label for="badge2025Font">å­—ä½“è‰² <span class="required">*</span></label>
                        <input type="color" id="badge2025Font" value="#ffffff" required>
                    </div>
                </div>
                <div class="shield-preview">
                    <h4>å¾½ç« é¢„è§ˆ</h4>
                    <img id="badge2025Preview" src="" alt="å¾½ç« é¢„è§ˆ">
                </div>
                <button class="btn" onclick="submitBadge2025()">æäº¤é…è‰²æ–¹æ¡ˆ</button>
                <button class="btn btn-cancel" onclick="cancelEdit('badge2025')" style="display: none;" id="cancelBadge2025Btn">å–æ¶ˆç¼–è¾‘</button>
            </div>
            <div class="vote-section">
                <h3>æŠ•ç¥¨ä¸æŸ¥çœ‹</h3>
                <div id="activity2Votes" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        <!-- æ´»åŠ¨ä¸‰ï¼šäº”å‘¨å²å¾½ç«  -->
        <div class="activity-section" id="activity3">
            <h2 class="activity-title">ğŸ† æ´»åŠ¨ä¸‰ï¼šäº”å‘¨å²å¾½ç« è®¾è®¡</h2>
            <div class="activity-desc"><p>è®¾è®¡"æ‘¸é±¼æ´¾5å²å•¦"ä¸“å±å¾½ç« ï¼é™¤äº†åç§°å›ºå®šå¤–ï¼Œå…¶ä»–å…ƒç´ éƒ½å¯ä»¥è‡ªç”±å®šåˆ¶ã€‚</p></div>
            <div id="activity3Rewards"></div>
            <div id="activity3Submission" style="display: none;"></div>
            <div id="activity3Form" style="display: none;">
                <div class="form-group">
                    <label for="badge5yTitle">è®¾è®¡æ ‡é¢˜ <span class="required">*</span></label>
                    <input type="text" id="badge5yTitle" placeholder="ç»™æ‚¨çš„å¾½ç« è®¾è®¡èµ·ä¸ªåå­—" maxlength="50" required>
                    <div class="error-message" id="badge5yTitleError">è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜</div>
                </div>
                <div class="form-group">
                    <label for="badge5yNote">è®¾è®¡æ€è·¯</label>
                    <textarea id="badge5yNote" placeholder="ä»‹ç»ä¸€ä¸‹æ‚¨çš„è®¾è®¡æ€è·¯..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="badge5yImageUpload">ä¸Šä¼ å¾½ç« å›¾ç‰‡</label>
                    <input type="file" id="badge5yImageUpload" accept="image/jpeg,image/jpg,image/png,image/webp" onchange="handleImageUpload(event)">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼ï¼Œä¸å»ºè®®ä½¿ç”¨é€æ˜å›¾å±‚ï¼ˆä¼šå½±å“æ•ˆæœï¼‰<br>
                        ä¸Šä¼ å›¾ç‰‡åéœ€è¦æäº¤è®¾è®¡æ–¹æ¡ˆæ‰èƒ½é¢„è§ˆæœ€ç»ˆæ•ˆæœ
                    </small>
                </div>
                <div class="form-group">
                    <label for="badge5yUrl">å¾½ç« å›¾ç‰‡URL</label>
                    <input type="text" id="badge5yUrl" placeholder="é»˜è®¤ä½¿ç”¨æ‚¨çš„å¤´åƒ">
                    <small style="color: #666; display: block; margin-top: 5px;">å¦‚æœä¸Šä¼ äº†å›¾ç‰‡ï¼Œæ­¤å­—æ®µå°†è‡ªåŠ¨å¡«å……</small>
                </div>
                <div class="color-input-group">
                    <div class="form-group">
                        <label for="badge5yBack">èƒŒæ™¯è‰² <span class="required">*</span></label>
                        <input type="color" id="badge5yBack" value="#db5a6b" required>
                    </div>
                    <div class="form-group">
                        <label for="badge5yFont">å­—ä½“è‰² <span class="required">*</span></label>
                        <input type="color" id="badge5yFont" value="#ffffff" required>
                    </div>
                </div>
                <div class="collapsible-section" style="display: none;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span>é«˜çº§é€‰é¡¹ (å¯é€‰)</span>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label for="badge5ySize">å°ºå¯¸è°ƒæ•´</label>
                            <input type="number" id="badge5ySize" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="1" max="1000">
                        </div>
                        <div class="form-group">
                            <label for="badge5yBorder">è¾¹æ¡†å®½åº¦</label>
                            <input type="number" id="badge5yBorder" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="0" max="50">
                        </div>
                        <div class="form-group">
                            <label for="badge5yBarlen">æ¡å®½åº¦</label>
                            <input type="number" id="badge5yBarlen" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="1" max="1000">
                        </div>
                        <div class="form-group">
                            <label for="badge5yFontsize">å­—ä½“å¤§å°</label>
                            <input type="number" id="badge5yFontsize" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="1" max="200">
                        </div>
                        <div class="form-group">
                            <label for="badge5yBarradius">åœ†è§’åŠå¾„</label>
                            <input type="number" id="badge5yBarradius" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="badge5yShadow">é˜´å½±æ•ˆæœ</label>
                            <select id="badge5yShadow">
                                <option value="">é»˜è®¤</option>
                                <option value="0">æ— é˜´å½±</option>
                                <option value="1">æœ‰é˜´å½±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="badge5yAnime">åŠ¨ç”»æ•ˆæœ</label>
                            <select id="badge5yAnime">
                                <option value="">é»˜è®¤</option>
                                <option value="0">æ— åŠ¨ç”»</option>
                                <option value="1">æœ‰åŠ¨ç”»</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="shield-preview">
                    <h4>å¾½ç« é¢„è§ˆ</h4>
                    <img id="badge5yPreview" src="" alt="å¾½ç« é¢„è§ˆ">
                </div>
                <button class="btn" onclick="submitBadge5Year()">æäº¤è®¾è®¡æ–¹æ¡ˆ</button>
                <button class="btn btn-cancel" onclick="cancelEdit('badge5year')" style="display: none;" id="cancelBadge5yearBtn">å–æ¶ˆç¼–è¾‘</button>
            </div>
            <div class="vote-section">
                <h3>æŠ•ç¥¨ä¸æŸ¥çœ‹</h3>
                <div id="activity3Votes" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å†å¹´å›é¡¾ -->
        <div class="activity-section" id="yearlyHistories">
            <h2>ğŸ“œ å†å¹´å›é¡¾</h2>
            <p>å›é¡¾æ‘¸é±¼æ´¾å†å¹´å‘¨å¹´åº†çš„ç²¾å½©ç¬é—´</p>
            <div id="historiesContainer" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- æŠ•ç¥¨è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="voteModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>æŠ•ç¥¨è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="voteModalContent">
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- å¾½ç« é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="badgePreviewModal" class="modal" onclick="closeBadgePreview(event)">
        <div class="modal-content badge-preview-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>å¾½ç« é¢„è§ˆ</h3>
                <button class="modal-close" onclick="closeBadgePreview()">&times;</button>
            </div>
            <div id="badgePreviewContent" class="badge-preview-content">
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- å†…å®¹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="contentDetailModal" class="content-detail-modal" onclick="closeContentDetail(event)">
        <div class="content-detail-content" onclick="event.stopPropagation()">
            <div class="content-detail-header">
                <h3 class="content-detail-title" id="contentDetailTitle">å†…å®¹è¯¦æƒ…</h3>
                <button class="content-detail-close" onclick="closeContentDetail()">&times;</button>
            </div>
            <div class="content-detail-author" id="contentDetailAuthor"></div>
            <div class="content-detail-body" id="contentDetailBody"></div>
        </div>
    </div>

    <script>
        // ============ æ´»åŠ¨æ—¶é—´å’Œå€’è®¡æ—¶åŠŸèƒ½ ============

        let activityStartTime = null;
        let countdownInterval = null;

        // æ£€æŸ¥æ´»åŠ¨æ˜¯å¦å·²å¼€å§‹
        function checkActivityTime(startTime) {
            const now = new Date();
            const start = new Date(startTime);

            if (now < start) {
                // æ´»åŠ¨æœªå¼€å§‹ï¼Œæ˜¾ç¤ºè’™ç‰ˆ
                activityStartTime = start;
                showOverlay();
                startCountdown();
                return false;
            }
            return true;
        }

        // æ˜¾ç¤ºè’™ç‰ˆ
        function showOverlay() {
            const overlay = document.getElementById('activityOverlay');
            if (overlay) {
                overlay.style.display = 'flex';

                // æ ¼å¼åŒ–å¼€å§‹æ—¶é—´
                const startTimeElement = document.getElementById('overlayStartTime');
                if (startTimeElement && activityStartTime) {
                    const formatted = formatDateTime(activityStartTime);
                    startTimeElement.textContent = `å¼€å§‹æ—¶é—´ï¼š${formatted}`;
                }
            }
        }

        // éšè—è’™ç‰ˆï¼ˆæŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…ï¼‰
        function hideOverlay() {
            const overlay = document.getElementById('activityOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            // ç»§ç»­ä¿æŒå€’è®¡æ—¶è¿è¡Œï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥éšæ—¶çœ‹åˆ°å‰©ä½™æ—¶é—´
        }

        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            updateCountdown(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // æ›´æ–°å€’è®¡æ—¶
        function updateCountdown() {
            if (!activityStartTime) return;

            const now = new Date();
            const diff = activityStartTime - now;

            if (diff <= 0) {
                // æ´»åŠ¨å·²å¼€å§‹ï¼Œåˆ·æ–°é¡µé¢
                clearInterval(countdownInterval);
                window.location.reload();
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const timerElement = document.getElementById('countdownTimer');
            if (!timerElement) return;

            let html = '';

            // å¦‚æœå¤§äº1å¤©ï¼Œæ˜¾ç¤ºå¤©æ•°
            if (days > 0) {
                html = `
                    <div class="countdown-item">
                        <span class="countdown-value">${days}</span>
                        <span class="countdown-unit">å¤©</span>
                    </div>
                `;
                // å¦‚æœè¶…è¿‡1å¤©ï¼Œåªæ˜¾ç¤ºå¤©æ•°
                if (days >= 1) {
                    timerElement.innerHTML = html;
                    return;
                }
            }

            // æ˜¾ç¤ºæ—¶åˆ†ç§’
            html = `
                <div class="countdown-item">
                    <span class="countdown-value">${String(hours).padStart(2, '0')}</span>
                    <span class="countdown-unit">æ—¶</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-value">${String(minutes).padStart(2, '0')}</span>
                    <span class="countdown-unit">åˆ†</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-value">${String(seconds).padStart(2, '0')}</span>
                    <span class="countdown-unit">ç§’</span>
                </div>
            `;

            timerElement.innerHTML = html;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // ============ å¯¼èˆªå’Œæ»šåŠ¨åŠŸèƒ½ ============

        // å›åˆ°é¡¶éƒ¨åŠŸèƒ½
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
        window.addEventListener('scroll', function() {
            const backToTopBtn = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }

            // é«˜äº®å½“å‰å¯è§†åŒºåŸŸå¯¹åº”çš„å¯¼èˆªé“¾æ¥
            highlightActiveNavLink();
        });

        // é«˜äº®å½“å‰åŒºåŸŸçš„å¯¼èˆªé“¾æ¥
        function highlightActiveNavLink() {
            const sections = ['activity1', 'activity2', 'activity3', 'yearlyHistories'];
            const navLinks = document.querySelectorAll('.nav-link');

            let currentSection = '';
            const scrollPosition = window.pageYOffset + 150; // åç§»é‡ï¼Œè€ƒè™‘å›ºå®šå¯¼èˆªæ 

            // æ‰¾åˆ°å½“å‰åœ¨è§†å£ä¸­çš„section
            for (const sectionId of sections) {
                const section = document.getElementById(sectionId);
                if (section) {
                    const sectionTop = section.offsetTop;
                    const sectionBottom = sectionTop + section.offsetHeight;

                    if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                        currentSection = sectionId;
                        break;
                    }
                }
            }

            // æ›´æ–°å¯¼èˆªé“¾æ¥çš„activeçŠ¶æ€
            navLinks.forEach(link => {
                const section = link.getAttribute('data-section');
                if (section === currentSection) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // å¹³æ»‘æ»šåŠ¨åˆ°æŒ‡å®šåŒºåŸŸ
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);

                if (targetElement) {
                    const navHeight = document.querySelector('.nav-bar').offsetHeight;
                    const targetPosition = targetElement.offsetTop - navHeight - 20;

                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // ============ åŸæœ‰ä»£ç  ============

        const ACTIVITY_IDS = {
            main: '9sftj1vraueq7r5',
            keyword: '3uxf93bj633hgea',
            badge2025: 'iik1f2s5lut99l6',
            badge5year: '7on0ywnk5y1upj0'
        };

        let currentUser = null;
        let isLoggedIn = false;
        let userSubmissions = {}; // è®°å½•ç”¨æˆ·çš„æŠ•ç¨¿ {activityId: articleId}
        let userVotes = {}; // è®°å½•ç”¨æˆ·çš„æŠ•ç¥¨ {activityId: {voteId, toUserId}}
        let voteQuotas = {}; // è®°å½•æŠ•ç¥¨é…é¢ {activityId: {total, used, remaining}}

        // é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œå¸¦ä¸Šå½“å‰é¡µé¢URL
        function redirectToLogin() {
            const currentUrl = window.location.href;
            window.location.href = `/fishpi/login?redirect=${encodeURIComponent(currentUrl)}`;
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œæœªç™»å½•åˆ™æç¤ºå¹¶è·³è½¬
        function requireLogin(message) {
            if (!isLoggedIn) {
                if (confirm(message || 'è¯·å…ˆç™»å½•åå†è¿›è¡Œæ­¤æ“ä½œï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
                    redirectToLogin();
                }
                return false;
            }
            return true;
        }

        // åˆå§‹åŒ–
        async function init() {
            await checkLogin();
            await loadMainActivity(); // åŠ è½½ä¸»æ´»åŠ¨ä¿¡æ¯
            await loadActivitiesRewards(); // åŠ è½½æ´»åŠ¨å¥–åŠ±ä¿¡æ¯
            if (isLoggedIn) {
                await loadUserSubmissions();
                await loadUserVotes();
                await loadVoteQuotas();
                showForms(); // åœ¨åŠ è½½å®Œæ•°æ®åå†æ˜¾ç¤ºè¡¨å•
            }
            setupEventListeners();
            loadAllVotes();
            loadYearlyHistories(); // åŠ è½½å†å¹´æ•°æ®
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLogin() {
            try {
                const response = await fetch('/user/me');
                if (response.ok) {
                    currentUser = await response.json();
                    isLoggedIn = true;

                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯åˆ°å¯¼èˆªæ 
                    const avatarHtml = currentUser.avatar
                        ? `<img src="${escapeHtml(currentUser.avatar)}" alt="avatar" class="nav-user-avatar" onerror="this.style.display='none'">`
                        : '';

                    document.getElementById('navUserInfo').innerHTML = `
                        ${avatarHtml}
                        <span class="nav-user-name">${escapeHtml(currentUser.nickname || currentUser.name)}</span>
                        <a href="/user/logout" class="nav-user-btn">é€€å‡ºç™»å½•</a>
                    `;
                } else {
                    isLoggedIn = false;
                    // æ˜¾ç¤ºç™»å½•æŒ‰é’®åˆ°å¯¼èˆªæ 
                    document.getElementById('navUserInfo').innerHTML = `
                        <a href="#" onclick="redirectToLogin(); return false;" class="nav-user-btn nav-login-btn">ç™»å½•</a>
                    `;
                    // æ˜¾ç¤ºç™»å½•æç¤º
                    document.getElementById('loginPrompt').style.display = 'block';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                isLoggedIn = false;
                // æ˜¾ç¤ºç™»å½•æŒ‰é’®åˆ°å¯¼èˆªæ 
                document.getElementById('navUserInfo').innerHTML = `
                    <a href="#" onclick="redirectToLogin(); return false;" class="nav-user-btn nav-login-btn">ç™»å½•</a>
                `;
                // æ˜¾ç¤ºç™»å½•æç¤º
                document.getElementById('loginPrompt').style.display = 'block';
            }
        }

        // åŠ è½½ä¸»æ´»åŠ¨ä¿¡æ¯
        async function loadMainActivity() {
            try {
                const response = await fetch(`/activity-api/activities/${ACTIVITY_IDS.main}`);
                if (response.ok) {
                    const mainActivity = await response.json();

                    // æ›´æ–°æ´»åŠ¨æ ‡é¢˜
                    if (mainActivity.name) {
                        document.getElementById('activityTitle').textContent = mainActivity.name;
                    }

                    // æ›´æ–°æ´»åŠ¨æè¿°
                    if (mainActivity.desc) {
                        const descElement = document.getElementById('activityDesc');
                        // å¦‚æœæ˜¯HTMLæ ¼å¼ï¼Œä½¿ç”¨innerHTMLï¼Œå¦åˆ™ä½¿ç”¨textContent
                        if (mainActivity.desc.includes('<')) {
                            descElement.innerHTML = mainActivity.desc;
                        } else {
                            descElement.textContent = mainActivity.desc;
                        }
                    }

                    // æ›´æ–°æ´»åŠ¨æ—¶é—´
                    if (mainActivity.start || mainActivity.end) {
                        const timeElement = document.getElementById('activityTime');
                        const timeValueElement = document.getElementById('activityTimeValue');

                        let timeText = '';
                        if (mainActivity.start && mainActivity.end) {
                            const startDate = new Date(mainActivity.start).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            const endDate = new Date(mainActivity.end).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            timeText = `${startDate} è‡³ ${endDate}`;
                        } else if (mainActivity.start) {
                            const startDate = new Date(mainActivity.start).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            timeText = `${startDate} å¼€å§‹`;
                        } else if (mainActivity.end) {
                            const endDate = new Date(mainActivity.end).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            timeText = `æˆªæ­¢ ${endDate}`;
                        }

                        if (timeText) {
                            timeValueElement.textContent = timeText;
                            timeElement.style.display = 'inline-block';
                        }

                        // æ£€æŸ¥æ´»åŠ¨æ˜¯å¦å·²å¼€å§‹
                        if (mainActivity.start) {
                            checkActivityTime(mainActivity.start);
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä¸»æ´»åŠ¨ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ´»åŠ¨å¥–åŠ±ä¿¡æ¯
        async function loadActivitiesRewards() {
            try {
                // å¹¶è¡ŒæŸ¥è¯¢ä¸‰ä¸ªå­æ´»åŠ¨çš„å¥–åŠ±ä¿¡æ¯
                const [keywordRewards, badge2025Rewards, badge5yearRewards] = await Promise.all([
                    fetch(`/activity-api/activities/${ACTIVITY_IDS.keyword}`).then(res => res.ok ? res.json() : null),
                    fetch(`/activity-api/activities/${ACTIVITY_IDS.badge2025}`).then(res => res.ok ? res.json() : null),
                    fetch(`/activity-api/activities/${ACTIVITY_IDS.badge5year}`).then(res => res.ok ? res.json() : null)
                ]);

                // å±•ç¤ºæ´»åŠ¨ä¿¡æ¯å’Œå¥–åŠ±
                if (keywordRewards) {
                    if (keywordRewards.name) {
                        updateActivityTitle('activity1', keywordRewards.name, keywordRewards.desc);
                        updateNavLink('activity1', keywordRewards.name);
                    }
                    if (keywordRewards.rewards && keywordRewards.rewards.length > 0) {
                        displayRewards('activity1Rewards', keywordRewards.rewards);
                    }
                }
                if (badge2025Rewards) {
                    if (badge2025Rewards.name) {
                        updateActivityTitle('activity2', badge2025Rewards.name, badge2025Rewards.desc);
                        updateNavLink('activity2', badge2025Rewards.name);
                    }
                    if (badge2025Rewards.rewards && badge2025Rewards.rewards.length > 0) {
                        displayRewards('activity2Rewards', badge2025Rewards.rewards);
                    }
                }
                if (badge5yearRewards) {
                    if (badge5yearRewards.name) {
                        updateActivityTitle('activity3', badge5yearRewards.name, badge5yearRewards.desc);
                        updateNavLink('activity3', badge5yearRewards.name);
                    }
                    if (badge5yearRewards.rewards && badge5yearRewards.rewards.length > 0) {
                        displayRewards('activity3Rewards', badge5yearRewards.rewards);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ´»åŠ¨å¥–åŠ±ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½å†å¹´æ•°æ®
        async function loadYearlyHistories() {
            try {
                const response = await fetch('/activity-api/yearly-histories');
                if (!response.ok) {
                    throw new Error('Failed to load yearly histories');
                }

                const data = await response.json();
                displayYearlyHistories(data.items || []);
            } catch (error) {
                console.error('åŠ è½½å†å¹´æ•°æ®å¤±è´¥:', error);
                document.getElementById('historiesContainer').innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— å†å¹´æ•°æ®</p>';
            }
        }

        // å±•ç¤ºå†å¹´æ•°æ®
        function displayYearlyHistories(histories) {
            const container = document.getElementById('historiesContainer');
            if (!container) return;

            if (!histories || histories.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— å†å¹´æ•°æ®</p>';
                return;
            }

            const historiesHtml = histories.map(history => {
                let shieldsHtml = '';

                // å‘¨å¹´æµè¡Œè‰²å¾½ç«  - ä½¿ç”¨badge.aweoo.com/genæ¥å£åŠ¨æ€ç”Ÿæˆ
                if (history.articleShield) {
                    const shield = history.articleShield;
                    let shieldUrl = `https://badge.aweoo.com/gen?ver=${shield.ver || '0.1'}&scale=${shield.scale || '0.79'}&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}`;
                    if (shield.url) {
                        shieldUrl += `&url=${encodeURIComponent(shield.url)}`;
                    }
                    // æ·»åŠ å¯é€‰å‚æ•°
                    const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                    optionalParams.forEach(param => {
                        if (shield[param] !== undefined && shield[param] !== '') {
                            shieldUrl += `&${param}=${shield[param]}`;
                        }
                    });

                    shieldsHtml += `
                        <div class="history-shield-item">
                            <span class="history-shield-label">æµè¡Œè‰²å¾½ç« :</span>
                            <img src="${shieldUrl}"
                                 alt="æµè¡Œè‰²å¾½ç« "
                                 referrerpolicy="no-referrer"
                                 onerror="this.style.display='none'">
                        </div>
                    `;
                }

                // å‘¨å²å¾½ç«  - ä½¿ç”¨badge.aweoo.com/genæ¥å£åŠ¨æ€ç”Ÿæˆ
                if (history.ageShield) {
                    const shield = history.ageShield;
                    let shieldUrl = `https://badge.aweoo.com/gen?ver=${shield.ver || '0.1'}&scale=${shield.scale || '0.79'}&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}`;
                    if (shield.url) {
                        shieldUrl += `&url=${encodeURIComponent(shield.url)}`;
                    }
                    // æ·»åŠ å¯é€‰å‚æ•°
                    const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                    optionalParams.forEach(param => {
                        if (shield[param] !== undefined && shield[param] !== '') {
                            shieldUrl += `&${param}=${shield[param]}`;
                        }
                    });

                    shieldsHtml += `
                        <div class="history-shield-item">
                            <span class="history-shield-label">å‘¨å²å¾½ç« :</span>
                            <img src="${shieldUrl}"
                                 alt="å‘¨å²å¾½ç« "
                                 referrerpolicy="no-referrer"
                                 onerror="this.style.display='none'">
                        </div>
                    `;
                }

                return `
                    <div class="history-card">
                        <div class="history-year">${history.year} å¹´</div>
                        ${history.keyword ? `<div class="history-keyword">å…³é”®è¯ï¼š${escapeHtml(history.keyword)}</div>` : ''}
                        ${shieldsHtml ? `<div class="history-shields">${shieldsHtml}</div>` : ''}
                        ${history.articleUrl ? `<a href="${escapeHtml(history.articleUrl)}" target="_blank" class="history-article-link">ğŸ“– æŸ¥çœ‹æ´»åŠ¨æ¨æ–‡</a>` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="histories-grid">${historiesHtml}</div>`;
        }


        // æ›´æ–°æ´»åŠ¨æ ‡é¢˜å’Œæè¿°
        function updateActivityTitle(activityId, name, desc) {
            const activitySection = document.getElementById(activityId);
            if (!activitySection) return;

            const h2 = activitySection.querySelector('.activity-title');
            const descDiv = activitySection.querySelector('.activity-desc');

            if (h2 && name) {
                // ä¿ç•™åŸæœ‰çš„å›¾æ ‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const icon = h2.textContent.match(/^[^\w\s]+/)?.[0] || '';
                h2.textContent = icon ? `${icon} ${name}` : name;
            }

            if (descDiv && desc) {
                // PocketBaseçš„rich editorè¿”å›HTMLæ ¼å¼ï¼Œç›´æ¥è®¾ç½®innerHTML
                descDiv.innerHTML = desc;
            }
        }

        // æ›´æ–°å¯¼èˆªé“¾æ¥æ–‡æœ¬
        function updateNavLink(activityId, name) {
            const navLink = document.querySelector(`.nav-link[data-section="${activityId}"]`);
            if (navLink && name) {
                // ä¿ç•™åŸæœ‰çš„å›¾æ ‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const icon = navLink.textContent.match(/^[^\w\s]+/)?.[0] || '';
                navLink.textContent = icon ? `${icon} ${name}` : name;
            }
        }

        // å±•ç¤ºå¥–åŠ±ä¿¡æ¯
        function displayRewards(containerId, rewards) {
            const container = document.getElementById(containerId);
            if (!container || !rewards || rewards.length === 0) {
                return;
            }

            // æŒ‰ç…§å¥–åŠ±æ’åºï¼ˆæœ€é«˜çš„åœ¨å‰é¢ï¼‰
            const sortedRewards = [...rewards].sort((a, b) => {
                // ä¼˜å…ˆæ¯”è¾ƒ point
                if (a.point !== b.point) {
                    return b.point - a.point;
                }
                // å¦‚æœ point ç›¸åŒï¼Œæ¯”è¾ƒ minï¼ˆåæ¬¡è¶Šå°è¶Šå¥½ï¼‰
                const aMin = a.min || 1;
                const bMin = b.min || 1;
                return aMin - bMin;
            });

            const rewardItems = sortedRewards.map((reward, index) => {
                // æ ¼å¼åŒ–åæ¬¡èŒƒå›´
                let rankText = '';
                if (reward.min === reward.max) {
                    rankText = `ç¬¬${reward.min}å`;
                } else if (reward.min && reward.max) {
                    rankText = `${reward.min}-${reward.max}å`;
                } else if (reward.min && !reward.max) {
                    rankText = `${reward.min}å+`;
                } else if (!reward.min && reward.max) {
                    rankText = `å‰${reward.max}å`;
                } else {
                    rankText = 'å‚ä¸å¥–';
                }

                // æ„å»ºå¥–åŠ±å†…å®¹
                let rewardContent = '';
                if (reward.point > 0) {
                    rewardContent += `<div class="reward-point">${reward.point}ç§¯åˆ†</div>`;
                }
                if (reward.more) {
                    rewardContent += `<div class="reward-point" style="font-size: 0.9rem; color: #fd7e14;">${escapeHtml(reward.more)}</div>`;
                }

                return `
                    <div class="reward-item">
                        <div class="reward-rank">${rankText}</div>
                        <div class="reward-details">
                            ${reward.name ? `<div class="reward-name">${escapeHtml(reward.name)}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${rewardContent}
                        </div>
                    </div>
                `;
            }).join('');

            const rewardsId = `rewards-${containerId}`;
            container.innerHTML = `
                <div class="rewards-section">
                    <h3 onclick="toggleRewards('${rewardsId}')">
                        å¥–åŠ±è¯´æ˜
                        <span class="rewards-toggle-icon" id="${rewardsId}-icon">â–¼</span>
                    </h3>
                    <div class="rewards-list collapsed" id="${rewardsId}">
                        ${rewardItems}
                    </div>
                </div>
            `;
        }

        // åˆ‡æ¢å¥–åŠ±å±•å¼€/æ”¶èµ·
        function toggleRewards(rewardsId) {
            const rewardsList = document.getElementById(rewardsId);
            const icon = document.getElementById(`${rewardsId}-icon`);

            if (rewardsList && icon) {
                rewardsList.classList.toggle('collapsed');
                icon.classList.toggle('expanded');
            }
        }


        // åŠ è½½ç”¨æˆ·æŠ•ç¨¿ä¿¡æ¯
        async function loadUserSubmissions() {
            try {
                const response = await fetch('/activity-api/shield-five-year/my-articles');
                if (response.ok) {
                    const data = await response.json();
                    if (data.items) {
                        data.items.forEach(article => {
                            userSubmissions[article.activityId] = article;
                        });
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æŠ•ç¨¿å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·æŠ•ç¥¨ä¿¡æ¯
        async function loadUserVotes() {
            try {
                const response = await fetch('/activity-api/shield-five-year/my-votes');
                if (response.ok) {
                    const data = await response.json();
                    if (data.items) {
                        data.items.forEach(vote => {
                            userVotes[vote.activityId] = vote;
                        });
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æŠ•ç¥¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½æŠ•ç¥¨é…é¢
        async function loadVoteQuotas() {
            for (const [key, activityId] of Object.entries(ACTIVITY_IDS)) {
                if (key === 'main') continue;
                try {
                    const response = await fetch(`/activity-api/shield-five-year/vote-quota/${activityId}`);
                    if (response.ok) {
                        const data = await response.json();
                        voteQuotas[activityId] = data;
                    }
                } catch (error) {
                    console.error(`åŠ è½½æŠ•ç¥¨é…é¢å¤±è´¥ (${key}):`, error);
                }
            }
        }

        // æ˜¾ç¤ºè¡¨å•
        function showForms() {
            // æ´»åŠ¨ä¸€ï¼šå…³é”®è¯
            if (userSubmissions[ACTIVITY_IDS.keyword]) {
                document.getElementById('activity1Form').style.display = 'none';
                displayMySubmission('keyword', userSubmissions[ACTIVITY_IDS.keyword], 'activity1Submission');
            } else {
                document.getElementById('activity1Form').style.display = 'block';
                document.getElementById('activity1Submission').style.display = 'none';
            }

            // æ´»åŠ¨äºŒï¼š2025æµè¡Œè‰²
            if (userSubmissions[ACTIVITY_IDS.badge2025]) {
                document.getElementById('activity2Form').style.display = 'none';
                displayMySubmission('badge2025', userSubmissions[ACTIVITY_IDS.badge2025], 'activity2Submission');
            } else {
                document.getElementById('activity2Form').style.display = 'block';
                document.getElementById('activity2Submission').style.display = 'none';
            }

            // æ´»åŠ¨ä¸‰ï¼šäº”å‘¨å²å¾½ç« 
            if (userSubmissions[ACTIVITY_IDS.badge5year]) {
                document.getElementById('activity3Form').style.display = 'none';
                displayMySubmission('badge5year', userSubmissions[ACTIVITY_IDS.badge5year], 'activity3Submission');
            } else {
                document.getElementById('activity3Form').style.display = 'block';
                document.getElementById('activity3Submission').style.display = 'none';
            }

            // è®¾ç½®ç”¨æˆ·å¤´åƒä½œä¸ºé»˜è®¤å¾½ç« å›¾ç‰‡çš„å ä½ç¬¦
            if (currentUser && currentUser.avatar) {
                const urlInput = document.getElementById('badge5yUrl');
                if (!urlInput.value) {
                    urlInput.value = currentUser.avatar;
                    urlInput.placeholder = `é»˜è®¤ä½¿ç”¨æ‚¨çš„å¤´åƒ: ${currentUser.avatar}`;
                }
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·çš„æŠ•ç¨¿å†…å®¹
        function displayMySubmission(activityKey, submission, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !submission) return;

            let shieldHtml = '';
            if (submission.shield) {
                const shield = submission.shield;
                let shieldUrl = `https://badge.aweoo.com/gen?ver=0.1&scale=0.79&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}`;
                if (shield.url) {
                    shieldUrl += `&url=${encodeURIComponent(shield.url)}`;
                }
                // æ·»åŠ å¯é€‰å‚æ•°
                const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                optionalParams.forEach(param => {
                    if (shield[param] !== undefined && shield[param] !== '') {
                        shieldUrl += `&${param}=${shield[param]}`;
                    }
                });
                shieldHtml = `
                    <div class="submission-shield">
                        <img src="${shieldUrl}" alt="å¾½ç« " referrerpolicy="no-referrer">
                    </div>
                `;
            }

            const html = `
                <div class="my-submission-display">
                    <h4>
                        <span>âœ¨ æ‚¨çš„æŠ•ç¨¿</span>
                        <button class="btn btn-warning btn-small" onclick="editSubmission('${activityKey}', '${submission.id}')">ç¼–è¾‘</button>
                    </h4>
                    <div class="submission-content">
                        <div class="submission-title">${escapeHtml(submission.title)}</div>
                        ${shieldHtml}
                        <div class="submission-text">${escapeHtml(submission.content)}</div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.style.display = 'block';
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(fn, delay) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // ç”Ÿæˆå¾½ç« URLçš„å…¬å…±å‡½æ•°
        function buildShieldUrl(shield) {
            if (!shield) return '';

            let url = `https://badge.aweoo.com/gen?ver=${shield.ver || '0.1'}&scale=${shield.scale || '0.79'}&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}`;

            if (shield.url) {
                url += `&url=${encodeURIComponent(shield.url)}`;
            }

            // æ·»åŠ å¯é€‰å‚æ•°
            const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
            optionalParams.forEach(param => {
                if (shield[param] !== undefined && shield[param] !== '') {
                    url += `&${param}=${shield[param]}`;
                }
            });

            return url;
        }

        // æ›´æ–°å¾½ç« é¢„è§ˆ
        function updateBadgePreview(type) {
            if (type === '2025') {
                const backcolor = document.getElementById('badge2025Back').value.substring(1);
                const fontcolor = document.getElementById('badge2025Font').value.substring(1);
                const defaultImage = 'https://file.fishpi.cn/2025/10/snake-d672120f.jpg';
                const url = `https://badge.aweoo.com/gen?ver=0.1&scale=0.79&txt=2025&url=${encodeURIComponent(defaultImage)}&backcolor=${backcolor}&fontcolor=${fontcolor}`;
                document.getElementById('badge2025Preview').src = url;
            } else if (type === '5year') {
                const txt = 'æ‘¸é±¼æ´¾5å²å•¦';
                let url = document.getElementById('badge5yUrl').value;
                if (!url && currentUser && currentUser.avatar) url = currentUser.avatar;
                if (!url) url = 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
                const backcolor = document.getElementById('badge5yBack').value.substring(1);
                const fontcolor = document.getElementById('badge5yFont').value.substring(1);

                const shield = {
                    text: txt,
                    url: url,
                    backcolor: backcolor,
                    fontcolor: fontcolor,
                    ver: '0.1',
                    scale: '0.79'
                };

                // æ·»åŠ å¯é€‰å‚æ•°
                const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                optionalParams.forEach(param => {
                    const inputId = 'badge5y' + param.charAt(0).toUpperCase() + param.slice(1);
                    const value = document.getElementById(inputId).value;
                    if (value !== '') shield[param] = value;
                });

                document.getElementById('badge5yPreview').src = buildShieldUrl(shield);
            }
        }

        // åŒ…è£…ä¸ºé˜²æŠ–ç‰ˆæœ¬
        const debouncedUpdateBadge2025Preview = debounce(() => updateBadgePreview('2025'), 600);
        const debouncedUpdateBadge5YearPreview = debounce(() => updateBadgePreview('5year'), 600);

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ´»åŠ¨ä¸€ï¼šå…³é”®è¯å­—æ®µéªŒè¯
            document.getElementById('keyword').addEventListener('blur', function() {
                validateField('keyword', 'keywordError', 'è¯·è¾“å…¥å…³é”®è¯');
            });
            document.getElementById('keywordDesc').addEventListener('blur', function() {
                validateField('keywordDesc', 'keywordDescError', 'è¯·è¾“å…¥å…³é”®è¯ä»‹ç»');
            });

            // æ´»åŠ¨äºŒï¼š2025æµè¡Œè‰²é¢„è§ˆå’ŒéªŒè¯
            document.getElementById('badge2025Title').addEventListener('blur', function() {
                validateField('badge2025Title', 'badge2025TitleError', 'è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜');
            });
            document.getElementById('badge2025Back').addEventListener('input', debouncedUpdateBadge2025Preview);
            document.getElementById('badge2025Font').addEventListener('input', debouncedUpdateBadge2025Preview);

            // æ´»åŠ¨ä¸‰ï¼šäº”å‘¨å²å¾½ç« éªŒè¯å’Œé¢„è§ˆ
            document.getElementById('badge5yTitle').addEventListener('blur', function() {
                validateField('badge5yTitle', 'badge5yTitleError', 'è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜');
            });
            ['badge5yUrl', 'badge5yBack', 'badge5yFont', 'badge5ySize', 'badge5yBorder',
             'badge5yBarlen', 'badge5yFontsize', 'badge5yBarradius', 'badge5yShadow', 'badge5yAnime'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', debouncedUpdateBadge5YearPreview);
            });

            // åˆå§‹é¢„è§ˆ
            updateBadgePreview('2025');
            updateBadgePreview('5year');

            // ä¸ºå¾½ç« é¢„è§ˆå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('badge2025Preview').addEventListener('click', function() {
                if (!this.src || this.src === '' || this.src.endsWith('/shield-five-year.html')) return;
                const backcolor = document.getElementById('badge2025Back').value.substring(1);
                const fontcolor = document.getElementById('badge2025Font').value.substring(1);
                const defaultImage = 'https://file.fishpi.cn/2025/10/snake-d672120f.jpg';
                const shield = {
                    text: '2025',
                    url: defaultImage,
                    backcolor: backcolor,
                    fontcolor: fontcolor,
                    ver: '0.1',
                    scale: '0.79'
                };
                const avatar = currentUser?.avatar || 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
                const nickname = currentUser?.nickname || currentUser?.name || 'æ¸¸å®¢';
                const name = currentUser?.name || '';
                showBadgePreview(avatar, nickname, name, shield, 'article');
            });

            document.getElementById('badge5yPreview').addEventListener('click', function() {
                if (!this.src || this.src === '' || this.src.endsWith('/shield-five-year.html')) return;
                const txt = 'æ‘¸é±¼æ´¾5å²å•¦';
                let url = document.getElementById('badge5yUrl').value;
                if (!url && currentUser && currentUser.avatar) url = currentUser.avatar;
                if (!url) url = 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
                const backcolor = document.getElementById('badge5yBack').value.substring(1);
                const fontcolor = document.getElementById('badge5yFont').value.substring(1);

                const shield = {
                    text: txt,
                    url: url,
                    backcolor: backcolor,
                    fontcolor: fontcolor,
                    ver: '0.1',
                    scale: '0.79'
                };

                // æ·»åŠ å¯é€‰å‚æ•°
                const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                optionalParams.forEach(param => {
                    const inputId = 'badge5y' + param.charAt(0).toUpperCase() + param.slice(1);
                    const value = document.getElementById(inputId).value;
                    if (value !== '') shield[param] = value;
                });

                const avatar = currentUser?.avatar || 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
                const nickname = currentUser?.nickname || currentUser?.name || 'æ¸¸å®¢';
                const name = currentUser?.name || '';
                showBadgePreview(avatar, nickname, name, shield, 'age');
            });
        }

        // éªŒè¯å­—æ®µ
        function validateField(fieldId, errorId, errorMessage) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            const value = field.value.trim();

            if (!value) {
                field.classList.add('error');
                error.classList.add('show');
                error.textContent = errorMessage;
                return false;
            } else {
                field.classList.remove('error');
                error.classList.remove('show');
                return true;
            }
        }

        // åˆ‡æ¢æŠ˜å åŒºåŸŸ
        function toggleCollapsible(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('active');
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        let uploadedImageFile = null;

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('åªæ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼çš„å›¾ç‰‡');
                event.target.value = '';
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                event.target.value = '';
                return;
            }

            // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰é€æ˜é€šé“
            try {
                const hasTransparency = await checkImageTransparency(file);
                if (hasTransparency) {
                    if (!confirm('æ£€æµ‹åˆ°å›¾ç‰‡åŒ…å«é€æ˜å›¾å±‚ï¼Œè¿™å¯èƒ½ä¼šå½±å“æœ€ç»ˆæ•ˆæœã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        event.target.value = '';
                        return;
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥å›¾ç‰‡é€æ˜åº¦å¤±è´¥:', error);
            }

            // ä¿å­˜æ–‡ä»¶å¼•ç”¨ï¼Œç­‰å¾…æäº¤æ—¶ä¸Šä¼ 
            uploadedImageFile = file;

            // æ¸…ç©ºURLè¾“å…¥æ¡†ï¼ˆå› ä¸ºè¦ä½¿ç”¨ä¸Šä¼ çš„å›¾ç‰‡ï¼‰
            document.getElementById('badge5yUrl').value = '';
            document.getElementById('badge5yUrl').placeholder = 'å·²é€‰æ‹©ä¸Šä¼ å›¾ç‰‡';

            alert('å›¾ç‰‡å·²é€‰æ‹©ï¼Œè¯·æäº¤è®¾è®¡æ–¹æ¡ˆåæŸ¥çœ‹æœ€ç»ˆæ•ˆæœ');
        }

        // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰é€æ˜é€šé“
        function checkImageTransparency(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        try {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;

                            // æ£€æŸ¥æ˜¯å¦æœ‰é€æ˜åƒç´ ï¼ˆalpha < 255ï¼‰
                            for (let i = 3; i < data.length; i += 4) {
                                if (data[i] < 255) {
                                    resolve(true);
                                    return;
                                }
                            }
                            resolve(false);
                        } catch (error) {
                            // å¦‚æœæ— æ³•è¯»å–åƒç´ æ•°æ®ï¼ˆå¯èƒ½æ˜¯è·¨åŸŸï¼‰ï¼Œå‡è®¾æ²¡æœ‰é€æ˜åº¦
                            resolve(false);
                        }
                    };
                    img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsDataURL(file);
            });
        }

        // æäº¤å…³é”®è¯
        async function submitKeyword() {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†æäº¤å…³é”®è¯')) {
                return;
            }

            // éªŒè¯å¿…å¡«å­—æ®µ
            const keywordValid = validateField('keyword', 'keywordError', 'è¯·è¾“å…¥å…³é”®è¯');
            const descValid = validateField('keywordDesc', 'keywordDescError', 'è¯·è¾“å…¥å…³é”®è¯ä»‹ç»');

            if (!keywordValid || !descValid) {
                return;
            }

            const keyword = document.getElementById('keyword').value.trim();
            const desc = document.getElementById('keywordDesc').value.trim();


            try {
                const response = await fetch('/activity-api/shield-five-year/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: ACTIVITY_IDS.keyword,
                        title: keyword,
                        content: desc
                    })
                });

                if (response.ok) {
                    alert('å…³é”®è¯æäº¤æˆåŠŸï¼');
                    document.getElementById('keyword').value = '';
                    document.getElementById('keywordDesc').value = '';
                    await loadUserSubmissions();
                    showForms();
                    loadArticles('keyword', 'activity1Votes');
                } else {
                    const error = await response.json();
                    alert(error.message || 'æäº¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æäº¤2025å¾½ç« é…è‰²
        async function submitBadge2025() {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†æäº¤é…è‰²æ–¹æ¡ˆ')) {
                return;
            }

            // éªŒè¯å¿…å¡«å­—æ®µ
            const titleValid = validateField('badge2025Title', 'badge2025TitleError', 'è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜');

            if (!titleValid) {
                return;
            }

            const title = document.getElementById('badge2025Title').value.trim();
            const note = document.getElementById('badge2025Note').value.trim();
            const backcolor = document.getElementById('badge2025Back').value.substring(1);
            const fontcolor = document.getElementById('badge2025Font').value.substring(1);

            try {
                const defaultImage = 'https://file.fishpi.cn/2025/10/snake-d672120f.jpg';

                // ä½¿ç”¨ FormData æäº¤æ‰€æœ‰æ•°æ®
                const formData = new FormData();
                formData.append('activityId', ACTIVITY_IDS.badge2025);
                formData.append('text', '2025');
                formData.append('url', defaultImage);
                formData.append('backcolor', backcolor);
                formData.append('fontcolor', fontcolor);
                formData.append('ver', '0.1');
                formData.append('scale', '0.79');
                formData.append('title', title);
                formData.append('note', note);

                // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå¾½ç« 
                const shieldResponse = await fetch('/activity-api/shield-five-year/shields', {
                    method: 'POST',
                    body: formData
                });

                if (!shieldResponse.ok) {
                    const error = await shieldResponse.json();
                    alert(error.message || 'å¾½ç« ä¿å­˜å¤±è´¥');
                    return;
                }

                const shieldData = await shieldResponse.json();
                const shieldId = shieldData.shield?.id;

                // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ–‡ç« å¹¶ç»‘å®šå¾½ç« 
                const articleResponse = await fetch('/activity-api/shield-five-year/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: ACTIVITY_IDS.badge2025,
                        title: title,
                        content: note || 'æˆ‘çš„2025å¾½ç« é…è‰²è®¾è®¡',
                        shieldId: shieldId
                    })
                });

                if (articleResponse.ok) {
                    alert('2025å¾½ç« é…è‰²æäº¤æˆåŠŸï¼');
                    document.getElementById('badge2025Title').value = '';
                    document.getElementById('badge2025Note').value = '';
                    await loadUserSubmissions();
                    showForms();
                    loadArticles('badge2025', 'activity2Votes');
                } else {
                    const error = await articleResponse.json();
                    alert(error.message || 'æ–‡ç« ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æäº¤äº”å‘¨å²å¾½ç« è®¾è®¡
        async function submitBadge5Year() {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†æäº¤å¾½ç« è®¾è®¡')) {
                return;
            }

            // éªŒè¯å¿…å¡«å­—æ®µ
            const titleValid = validateField('badge5yTitle', 'badge5yTitleError', 'è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜');

            if (!titleValid) {
                return;
            }

            const title = document.getElementById('badge5yTitle').value.trim();
            const note = document.getElementById('badge5yNote').value.trim();
            const text = 'æ‘¸é±¼æ´¾5å²å•¦';
            let url = document.getElementById('badge5yUrl').value;

            // å¦‚æœæ²¡æœ‰ä¸Šä¼ å›¾ç‰‡ä¸”æ²¡æœ‰è¾“å…¥URLï¼Œä½¿ï¿½ï¿½ç”¨æˆ·å¤´åƒ
            if (!uploadedImageFile && !url && currentUser && currentUser.avatar) {
                url = currentUser.avatar;
            }

            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰URLï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡
            if (!uploadedImageFile && !url) {
                url = 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
            }

            const backcolor = document.getElementById('badge5yBack').value.substring(1);
            const fontcolor = document.getElementById('badge5yFont').value.substring(1);

            try {
                // ç»Ÿä¸€ä½¿ç”¨ FormData æäº¤æ‰€æœ‰æ•°æ®
                const formData = new FormData();
                formData.append('activityId', ACTIVITY_IDS.badge5year);
                formData.append('text', text);
                formData.append('url', url);
                formData.append('backcolor', backcolor);
                formData.append('fontcolor', fontcolor);
                formData.append('ver', '0.1');
                formData.append('scale', '0.79');
                formData.append('title', title);
                formData.append('note', note);

                // æ·»åŠ å¯é€‰å‚æ•°
                const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                optionalParams.forEach(param => {
                    const inputId = 'badge5y' + param.charAt(0).toUpperCase() + param.slice(1);
                    const value = document.getElementById(inputId).value;
                    if (value !== '') {
                        formData.append(param, value);
                    }
                });

                // å¦‚æœæœ‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ·»åŠ åˆ° FormData
                if (uploadedImageFile) {
                    formData.append('img', uploadedImageFile);
                }

                // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå¾½ç« 
                const shieldResponse = await fetch('/activity-api/shield-five-year/shields', {
                    method: 'POST',
                    body: formData
                });

                if (!shieldResponse.ok) {
                    const error = await shieldResponse.json();
                    alert(error.message || 'å¾½ç« ä¿å­˜å¤±è´¥');
                    return;
                }

                const shieldData = await shieldResponse.json();
                const shieldId = shieldData.shield?.id;

                // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ–‡ç« å¹¶ç»‘å®šå¾½ç« 
                const articleResponse = await fetch('/activity-api/shield-five-year/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: ACTIVITY_IDS.badge5year,
                        title: title,
                        content: note || 'æˆ‘çš„äº”å‘¨å²å¾½ç« è®¾è®¡',
                        shieldId: shieldId
                    })
                });

                if (articleResponse.ok) {
                    alert('äº”å‘¨å²å¾½ç« è®¾è®¡æäº¤æˆåŠŸï¼' + (uploadedImageFile ? 'å›¾ç‰‡å·²ä¸Šä¼ ï¼Œåˆ·æ–°é¡µé¢å³å¯æŸ¥çœ‹æœ€ç»ˆæ•ˆæœã€‚' : ''));
                    document.getElementById('badge5yTitle').value = '';
                    document.getElementById('badge5yNote').value = '';
                    document.getElementById('badge5yImageUpload').value = '';
                    uploadedImageFile = null;
                    await loadUserSubmissions();
                    showForms();
                    loadArticles('badge5year', 'activity3Votes');
                } else {
                    const error = await articleResponse.json();
                    alert(error.message || 'æ–‡ç« ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åŠ è½½æ‰€æœ‰æŠ•ç¥¨
        async function loadAllVotes() {
            await loadArticles('keyword', 'activity1Votes');
            await loadArticles('badge2025', 'activity2Votes');
            await loadArticles('badge5year', 'activity3Votes');
        }

        // åŠ è½½æ–‡ç« åˆ—è¡¨ï¼ˆå…³é”®è¯æ´»åŠ¨ï¼‰
        async function loadArticles(activityKey, containerId, sortBy = 'votes', sortOrder = 'desc') {
            const activityId = ACTIVITY_IDS[activityKey];
            try {
                const [articlesRes, statsRes] = await Promise.all([
                    fetch(`/activity-api/shield-five-year/articles/${activityId}`),
                    fetch(`/activity-api/shield-five-year/vote-stats/${activityId}`)
                ]);

                if (!articlesRes.ok) {
                    throw new Error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥');
                }

                const articlesData = await articlesRes.json();
                const statsData = statsRes.ok ? await statsRes.json() : { stats: {} };

                renderArticles(articlesData.items || [], statsData.stats || {}, activityId, containerId, activityKey, sortBy, sortOrder);
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                document.getElementById(containerId).innerHTML = '<p class="error">åŠ è½½æ•°æ®å¤±è´¥</p>';
            }
        }

        // æ¸²æŸ“æ–‡ç« åˆ—è¡¨
        function renderArticles(articles, stats, activityId, containerId, activityKey, sortBy = 'votes', sortOrder = 'desc') {
            const container = document.getElementById(containerId);

            if (articles.length === 0) {
                container.innerHTML = '<p>æš‚æ— æŠ•ç¨¿</p>';
                return;
            }

            // æ·»åŠ åˆ›å»ºæ—¶é—´å’Œç¥¨æ•°ä¿¡æ¯
            const articlesWithMeta = articles.map(article => ({
                ...article,
                voteCount: stats[article.user?.id] || 0,
                isMySubmission: isLoggedIn && currentUser && article.user?.id === currentUser.id,
                isVoted: isLoggedIn && userVotes[activityId]?.toUserId === article.user?.id,
                created: new Date(article.created || 0)
            }));

            // æ’åº
            articlesWithMeta.sort((a, b) => {
                let comparison = 0;
                if (sortBy === 'votes') {
                    comparison = a.voteCount - b.voteCount;
                } else if (sortBy === 'time') {
                    comparison = a.created - b.created;
                }
                return sortOrder === 'desc' ? -comparison : comparison;
            });

            // è·å–æŠ•ç¥¨é…é¢ä¿¡æ¯
            const quota = voteQuotas[activityId] || { total: 0, used: 0, remaining: 0 };
            const canVote = isLoggedIn && quota.remaining > 0;

            // æ¸²æŸ“æ’åºæ§ä»¶å’ŒæŠ•ç¥¨é…é¢ä¿¡æ¯
            const sortControlsHtml = `
                <div class="sort-controls">
                    <div class="sort-buttons">
                        <button class="sort-btn ${sortBy === 'votes' && sortOrder === 'desc' ? 'active' : ''}"
                                onclick="loadArticles('${activityKey}', '${containerId}', 'votes', 'desc')">
                            ç¥¨æ•°é™åº
                        </button>
                        <button class="sort-btn ${sortBy === 'votes' && sortOrder === 'asc' ? 'active' : ''}"
                                onclick="loadArticles('${activityKey}', '${containerId}', 'votes', 'asc')">
                            ç¥¨æ•°å‡åº
                        </button>
                        <button class="sort-btn ${sortBy === 'time' && sortOrder === 'desc' ? 'active' : ''}"
                                onclick="loadArticles('${activityKey}', '${containerId}', 'time', 'desc')">
                            æ—¶é—´é™åº
                        </button>
                        <button class="sort-btn ${sortBy === 'time' && sortOrder === 'asc' ? 'active' : ''}"
                                onclick="loadArticles('${activityKey}', '${containerId}', 'time', 'asc')">
                            æ—¶é—´å‡åº
                        </button>
                    </div>
                    ${isLoggedIn ? `
                    <div class="vote-quota-container">
                        <div class="vote-quota-item">
                            <span class="vote-quota-label">å¯æŠ•ç¥¨ï¼š</span>
                            <span class="vote-quota-value vote-quota-remaining">${quota.remaining}</span>
                        </div>
                        <span class="vote-quota-separator">|</span>
                        <div class="vote-quota-item">
                            <span class="vote-quota-label">å·²æŠ•ç¥¨ï¼š</span>
                            <span class="vote-quota-value vote-quota-used">${quota.used}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            const html = articlesWithMeta.map(article => {
                // å¦‚æœæ–‡ç« æœ‰å…³è”çš„å¾½ç« ï¼Œç”Ÿæˆå¾½ç« URL
                let shieldHtml = '';
                if (article.shield) {
                    const shield = article.shield;
                    const shieldUrl = `https://badge.aweoo.com/gen?ver=0.1&scale=0.79&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}${shield.url ? '&url=' + encodeURIComponent(shield.url) : ''}`;

                    // ç¡®å®šæ´»åŠ¨ç±»å‹ï¼ˆç”¨äºåŠ è½½å¯¹åº”çš„å†å¹´å¾½ç« ï¼‰
                    // badge5year(äº”å‘¨å²å¾½ç« )åº”è¯¥å±•ç¤ºå†å¹´å‘¨å²å¾½ç« (age)
                    // badge2025(æµè¡Œè‰²å¾½ç« )åº”è¯¥å±•ç¤ºå†å¹´æµè¡Œè‰²å¾½ç« (article)
                    const activityType = activityKey === 'badge5year' ? 'age' : 'article';

                    // å°†shieldå¯¹è±¡è½¬ä¸ºJSONå­—ç¬¦ä¸²ï¼Œç”¨äºç‚¹å‡»äº‹ä»¶ä¼ å‚
                    const shieldJson = JSON.stringify(shield).replace(/"/g, '&quot;');

                    shieldHtml = `
                        <img src="${shieldUrl}" alt="å¾½ç« "
                             referrerpolicy="no-referrer"
                             onmouseover="this.style.transform='scale(1.05)'"
                             onmouseout="this.style.transform='scale(1)'"
                             onclick='showBadgePreview("${escapeHtml(article.user?.avatar || '')}", "${escapeHtml(article.user?.nickname || article.user?.name || 'åŒ¿å')}", "${escapeHtml(article.user?.name || '')}", ${shieldJson}, "${activityType}")'>
                    `;
                }

                // æŠ•ç¥¨æŒ‰é’®æˆ–ç¼–è¾‘æŒ‰é’®
                let actionButtons = '';
                if (article.isMySubmission) {
                    actionButtons = `<button class="btn btn-warning btn-small" onclick="editSubmission('${activityKey}', '${article.id}')">ç¼–è¾‘</button>`;
                } else if (isLoggedIn) {
                    if (article.isVoted) {
                        actionButtons = `<button class="btn btn-secondary btn-small" onclick="cancelVote('${activityId}')">å–æ¶ˆæŠ•ç¥¨</button>`;
                    } else if (canVote) {
                        actionButtons = `<button class="btn btn-small" onclick="voteFor('${activityId}', '${article.user?.id}')">æŠ•ç¥¨</button>`;
                    } else if (quota.remaining === 0 && quota.used > 0) {
                        actionButtons = `<button class="btn btn-small" disabled>ç¥¨æ•°å·²ç”¨å®Œ</button>`;
                    }
                }

                // æ£€æŸ¥æè¿°é•¿åº¦ï¼Œå†³å®šæ˜¯å¦éœ€è¦"æŸ¥çœ‹å…¨éƒ¨"æŒ‰é’®
                // åŒæ—¶è€ƒè™‘å­—ç¬¦æ•°å’Œè¡Œæ•°ï¼Œæ»¡è¶³ä»»ä¸€æ¡ä»¶å°±æ˜¾ç¤ºæŒ‰é’®
                const contentLength = article.content.length;
                const lineCount = (article.content.match(/\n/g) || []).length + 1; // æ¢è¡Œç¬¦æ•°é‡+1
                const needsViewBtn = contentLength > 150 || lineCount > 4; // è¶…è¿‡150å­—ç¬¦æˆ–è¶…è¿‡4è¡Œ

                // è½¬ä¹‰ç”¨æˆ·æ•°æ®ç”¨äºJSONä¼ é€’
                const articleDataJson = JSON.stringify({
                    title: article.title,
                    content: article.content,
                    avatar: article.user?.avatar || '',
                    nickname: article.user?.nickname || article.user?.name || 'åŒ¿å'
                }).replace(/"/g, '&quot;');

                return `
                    <div class="vote-item ${article.isVoted ? 'voted' : ''} ${article.isMySubmission ? 'my-submission' : ''}">
                        <div class="vote-item-header">
                            <img src="${escapeHtml(article.user?.avatar || '')}"
                                 alt="avatar" class="vote-item-avatar"
                                 onclick="window.open('https://fishpi.cn/member/${escapeHtml(article.user?.name || '')}', '_blank')"
                                 title="æŸ¥çœ‹ ${escapeHtml(article.user?.nickname || article.user?.name || 'åŒ¿å')} çš„ä¸»é¡µ"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22><rect width=%2232%22 height=%2232%22 fill=%22%23ddd%22/></svg>'">
                            <div class="vote-item-name"
                                 onclick="window.open('https://fishpi.cn/member/${escapeHtml(article.user?.name || '')}', '_blank')"
                                 title="æŸ¥çœ‹ ${escapeHtml(article.user?.nickname || article.user?.name || 'åŒ¿å')} çš„ä¸»é¡µ">
                                ${escapeHtml(article.user?.nickname || article.user?.name || 'åŒ¿å')}
                                ${article.isMySubmission ? ' <span style="color: #ff9800; font-size: 0.875rem;">â˜…</span>' : ''}
                            </div>
                        </div>
                        <div class="vote-item-content">
                            <div class="vote-item-keyword">${escapeHtml(article.title)}</div>
                            ${shieldHtml ? `<div class="vote-item-shield">${shieldHtml}</div>` : ''}
                            <div class="vote-item-description ${needsViewBtn ? '' : 'short'}">${escapeHtml(article.content)}</div>
                            ${needsViewBtn ? `
                                <div class="view-full-btn" onclick='showContentDetail(${articleDataJson})'>
                                    <span>ğŸ“– æŸ¥çœ‹å…¨éƒ¨</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="vote-item-actions">
                            <span class="vote-count" onclick="showVoteDetails('${activityId}', '${article.user?.id}')">â¤ï¸ ${article.voteCount} ç¥¨</span>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = sortControlsHtml + `<div class="vote-list">${html}</div>`;
        }

        // æ˜¾ç¤ºå†…å®¹è¯¦æƒ…å¼¹çª—
        function showContentDetail(articleData) {
            const modal = document.getElementById('contentDetailModal');
            const titleElement = document.getElementById('contentDetailTitle');
            const authorElement = document.getElementById('contentDetailAuthor');
            const bodyElement = document.getElementById('contentDetailBody');

            if (!modal || !titleElement || !authorElement || !bodyElement) return;

            // è®¾ç½®æ ‡é¢˜
            titleElement.textContent = articleData.title;

            // è®¾ç½®ä½œè€…ä¿¡æ¯
            authorElement.innerHTML = `
                <img src="${escapeHtml(articleData.avatar)}"
                     alt="avatar"
                     class="content-detail-avatar"
                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%23ddd%22/></svg>'">
                <div class="content-detail-author-info">
                    <div class="content-detail-author-name">${escapeHtml(articleData.nickname)}</div>
                    <div class="content-detail-author-label">ä½œè€…</div>
                </div>
            `;

            // è®¾ç½®å†…å®¹
            bodyElement.textContent = articleData.content;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
        }

        // å…³é—­å†…å®¹è¯¦æƒ…å¼¹çª—
        function closeContentDetail(event) {
            if (event && event.target.id !== 'contentDetailModal') return;

            const modal = document.getElementById('contentDetailModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            }
        }

        // æŠ•ç¥¨
        async function voteFor(activityId, targetUserId) {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†æŠ•ç¥¨')) {
                return;
            }

            // å¼¹çª—è®©ç”¨æˆ·è¾“å…¥è¯„è®ºï¼ˆå¯é€‰ï¼‰
            const comment = prompt('è¯·è¾“å…¥æ‚¨çš„è¯„è®ºï¼ˆå¯é€‰ï¼ŒæŒ‰å–æ¶ˆåˆ™ä¸å¡«å†™è¯„è®ºï¼‰ï¼š');

            // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆæŒ‰é’®
            if (comment === null) {
                return;
            }

            try {
                const response = await fetch('/activity-api/shield-five-year/vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: activityId,
                        toUserId: targetUserId,
                        comment: comment.trim()
                    })
                });

                if (response.ok) {
                    alert('æŠ•ç¥¨æˆåŠŸï¼');
                    await loadUserVotes();
                    await loadVoteQuotas();
                    loadAllVotes();
                } else {
                    const error = await response.json();
                    alert(error.message || 'æŠ•ç¥¨å¤±è´¥');
                }
            } catch (error) {
                console.error('æŠ•ç¥¨å¤±è´¥:', error);
                alert('æŠ•ç¥¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // å–æ¶ˆæŠ•ç¥¨
        async function cancelVote(activityId) {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†å–æ¶ˆæŠ•ç¥¨')) {
                return;
            }

            if (!confirm('ç¡®å®šè¦å–æ¶ˆæŠ•ç¥¨å—ï¼Ÿå–æ¶ˆåå¯ä»¥é‡æ–°æŠ•ç»™å…¶ä»–äººã€‚')) {
                return;
            }

            try {
                const vote = userVotes[activityId];
                if (!vote || !vote.id) {
                    alert('æœªæ‰¾åˆ°æŠ•ç¥¨è®°å½•');
                    return;
                }

                const response = await fetch(`/activity-api/shield-five-year/vote/${vote.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    alert('å·²å–æ¶ˆæŠ•ç¥¨ï¼');
                    // ç«‹å³æ¸…é™¤æœ¬åœ°æŠ•ç¥¨è®°å½•
                    delete userVotes[activityId];
                    await loadUserVotes();
                    await loadVoteQuotas();
                    loadAllVotes();
                } else {
                    const error = await response.json();
                    alert(error.message || 'å–æ¶ˆæŠ•ç¥¨å¤±è´¥');
                }
            } catch (error) {
                console.error('å–æ¶ˆæŠ•ç¥¨å¤±è´¥:', error);
                alert('å–æ¶ˆæŠ•ç¥¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºæŠ•ç¥¨è¯¦æƒ…
        async function showVoteDetails(activityId, targetUserId) {
            const modal = document.getElementById('voteModal');
            const modalContent = document.getElementById('voteModalContent');

            modal.classList.add('show');
            modalContent.innerHTML = '<p>åŠ è½½ä¸­...</p>';

            try {
                const response = await fetch(`/activity-api/shield-five-year/vote-details/${activityId}/${targetUserId}`);

                if (response.ok) {
                    const data = await response.json();
                    const voters = data.voters || [];

                    if (voters.length === 0) {
                        modalContent.innerHTML = '<p>æš‚æ— æŠ•ç¥¨</p>';
                        return;
                    }

                    // ç»Ÿè®¡æœ‰æ•ˆç¥¨æ•°
                    const validVoters = voters.filter(voter => voter.valid === 'valid');
                    const invalidVoters = voters.filter(voter => voter.valid === 'invalid');

                    const votersHtml = voters.map(voter => {
                        const time = new Date(voter.created).toLocaleString('zh-CN');
                        const comment = voter.comment ? escapeHtml(voter.comment) : '';
                        const commentHtml = comment ? `<div class="voter-comment">${comment}</div>` : '';
                        const isInvalid = voter.valid === 'invalid';
                        const invalidClass = isInvalid ? ' invalid-vote' : '';
                        const recentUserBadge = isInvalid ? '<span class="recent-user-badge" title="æ³¨å†Œæœªæ»¡3ä¸ªæœˆï¼Œæ­¤ç¥¨æ— æ•ˆ">è¿‘æœŸæ³¨å†Œç”¨æˆ·</span>' : '';

                        return `
                            <div class="voter-item${invalidClass}">
                                <div class="voter-header">
                                    <img src="${escapeHtml(voter.user?.avatar || '')}"
                                         alt="avatar" class="voter-avatar"
                                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2230%22 height=%2230%22><rect width=%2230%22 height=%2230%22 fill=%22%23ddd%22/></svg>'">
                                    <div class="voter-info">
                                        <div class="voter-name-line">
                                            <span class="voter-name">${escapeHtml(voter.user?.nickname || voter.user?.name || 'åŒ¿å')}</span>
                                            ${recentUserBadge}
                                        </div>
                                        <span class="voter-time">${time}</span>
                                    </div>
                                </div>
                                ${commentHtml}
                            </div>
                        `;
                    }).join('');

                    const voteCountHtml = invalidVoters.length > 0
                        ? `<p style="margin-bottom: 15px;">å…± ${voters.length} äººæŠ•ç¥¨ï¼ˆæ­£å¼ç¥¨ ${validVoters.length} å¼ ï¼Œè¿‘æœŸç¥¨ ${invalidVoters.length} å¼ ï¼‰</p>`
                        : `<p style="margin-bottom: 15px;">å…± ${validVoters.length} äººæŠ•ç¥¨</p>`;

                    modalContent.innerHTML = `
                        ${voteCountHtml}
                        <div class="voter-list">${votersHtml}</div>
                    `;
                } else {
                    modalContent.innerHTML = '<p class="error">åŠ è½½å¤±è´¥</p>';
                }
            } catch (error) {
                console.error('åŠ è½½æŠ•ç¥¨è¯¦æƒ…å¤±è´¥:', error);
                modalContent.innerHTML = '<p class="error">åŠ è½½å¤±è´¥</p>';
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(event) {
            if (!event || event.target.id === 'voteModal') {
                document.getElementById('voteModal').classList.remove('show');
            }
        }

        // å…³é—­å¾½ç« é¢„è§ˆå¼¹çª—
        function closeBadgePreview(event) {
            if (!event || event.target.id === 'badgePreviewModal') {
                document.getElementById('badgePreviewModal').classList.remove('show');
            }
        }

        // æ˜¾ç¤ºå¾½ç« é¢„è§ˆ
        async function showBadgePreview(userAvatar, nickname, name, currentShield, activityType) {
            const modal = document.getElementById('badgePreviewModal');
            const modalContent = document.getElementById('badgePreviewContent');

            modal.classList.add('show');
            modalContent.innerHTML = '<p>åŠ è½½ä¸­...</p>';

            try {
                // è·å–å†å¹´æ•°æ®
                const response = await fetch('/activity-api/yearly-histories');
                let allBadges = [];

                // æ·»åŠ å½“å‰é¢„è§ˆçš„å¾½ç« 
                if (currentShield) {
                    allBadges.push(currentShield);
                }

                if (response.ok) {
                    const data = await response.json();
                    const histories = data.items || [];

                    // æ ¹æ®æ´»åŠ¨ç±»å‹æ”¶é›†å†å¹´å¾½ç« 
                    histories.forEach(history => {
                        if (activityType === 'article' && history.articleShield) {
                            allBadges.push(history.articleShield);
                        } else if (activityType === 'age' && history.ageShield) {
                            allBadges.push(history.ageShield);
                        }
                    });
                }

                // æ„å»ºå¾½ç« HTMLï¼ˆåŸå§‹æ¯”ä¾‹ï¼‰
                const badgesHtml = allBadges.map(shield => {
                    let shieldUrl = `https://badge.aweoo.com/gen?ver=${shield.ver || '0.1'}&scale=${shield.scale || '0.79'}&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}`;
                    if (shield.url) {
                        shieldUrl += `&url=${encodeURIComponent(shield.url)}`;
                    }
                    // æ·»åŠ å¯é€‰å‚æ•°
                    const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                    optionalParams.forEach(param => {
                        if (shield[param] !== undefined && shield[param] !== '') {
                            shieldUrl += `&${param}=${shield[param]}`;
                        }
                    });
                    return `<img src="${shieldUrl}" alt="å¾½ç« " referrerpolicy="no-referrer">`;
                }).join('');

                // æ„å»º3å€ç¼©æ”¾å¾½ç« HTML
                const scaledBadgesHtml = [currentShield].map(shield => {
                    let shieldUrl = `https://badge.aweoo.com/gen?ver=${shield.ver || '0.1'}&scale=3&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}`;
                    if (shield.url) {
                        shieldUrl += `&url=${encodeURIComponent(shield.url)}`;
                    }
                    // æ·»åŠ å¯é€‰å‚æ•°
                    const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                    optionalParams.forEach(param => {
                        if (shield[param] !== undefined && shield[param] !== '') {
                            shieldUrl += `&${param}=${shield[param]}`;
                        }
                    });
                    return `<img src="${shieldUrl}" alt="å¾½ç« 3å€ç¼©æ”¾" referrerpolicy="no-referrer">`;
                }).join('');

                // æ„å»ºå®Œæ•´çš„é¢„è§ˆå†…å®¹
                modalContent.innerHTML = `
                    <img src="${escapeHtml(userAvatar)}" alt="å¤´åƒ" class="badge-preview-avatar"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22210%22 height=%22210%22><rect width=%22210%22 height=%22210%22 fill=%22%23ddd%22/></svg>'">
                    <div class="badge-preview-nickname">${escapeHtml(nickname)}</div>
                    <div class="badge-preview-name">${escapeHtml(name)}</div>
                    <div class="badge-preview-badges">
                        ${badgesHtml || '<p>æš‚æ— å¾½ç« </p>'}
                    </div>
                    ${allBadges.length > 0 ? `
                        <div class="badge-preview-divider"></div>
                        <div class="badge-preview-scaled">
                            ${scaledBadgesHtml}
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('åŠ è½½å¾½ç« é¢„è§ˆå¤±è´¥:', error);
                modalContent.innerHTML = '<p class="error">åŠ è½½å¤±è´¥</p>';
            }
        }

        // ç¼–è¾‘æŠ•ç¨¿
        async function editSubmission(activityKey, articleId) {
            const activityId = ACTIVITY_IDS[activityKey];
            const submission = userSubmissions[activityId];

            if (!submission) {
                alert('æœªæ‰¾åˆ°æŠ•ç¨¿è®°å½•');
                return;
            }

            // æ ¹æ®ä¸åŒæ´»åŠ¨æ˜¾ç¤ºä¸åŒçš„ç¼–è¾‘è¡¨å•
            if (activityKey === 'keyword') {
                document.getElementById('keyword').value = submission.title || '';
                document.getElementById('keywordDesc').value = submission.content || '';
                document.getElementById('activity1Form').style.display = 'block';
                document.getElementById('activity1Submission').style.display = 'none';
                document.querySelector('#activity1Form .btn').textContent = 'æ›´æ–°å…³é”®è¯';
                document.querySelector('#activity1Form .btn').onclick = () => updateSubmission('keyword', articleId);
                document.getElementById('cancelKeywordBtn').style.display = 'inline-block';
                document.getElementById('activity1Form').scrollIntoView({ behavior: 'smooth' });
            } else if (activityKey === 'badge2025') {
                document.getElementById('badge2025Title').value = submission.title || '';
                document.getElementById('badge2025Note').value = submission.content || '';
                if (submission.shield) {
                    document.getElementById('badge2025Back').value = '#' + (submission.shield.backcolor || 'db5a6b');
                    document.getElementById('badge2025Font').value = '#' + (submission.shield.fontcolor || 'ffffff');
                }
                updateBadgePreview('2025');
                document.getElementById('activity2Form').style.display = 'block';
                document.getElementById('activity2Submission').style.display = 'none';
                document.querySelector('#activity2Form .btn').textContent = 'æ›´æ–°é…è‰²æ–¹æ¡ˆ';
                document.querySelector('#activity2Form .btn').onclick = () => updateSubmission('badge2025', articleId);
                document.getElementById('cancelBadge2025Btn').style.display = 'inline-block';
                document.getElementById('activity2Form').scrollIntoView({ behavior: 'smooth' });
            } else if (activityKey === 'badge5year') {
                document.getElementById('badge5yTitle').value = submission.title || '';
                document.getElementById('badge5yNote').value = submission.content || '';
                document.getElementById('badge5yImageUpload').value = '';
                uploadedImageFile = null; // é‡ç½®ä¸Šä¼ çš„å›¾ç‰‡
                if (submission.shield) {
                    document.getElementById('badge5yUrl').value = submission.shield.url || '';
                    document.getElementById('badge5yUrl').placeholder = 'é»˜è®¤ä½¿ç”¨æ‚¨çš„å¤´åƒ';
                    document.getElementById('badge5yBack').value = '#' + (submission.shield.backcolor || 'db5a6b');
                    document.getElementById('badge5yFont').value = '#' + (submission.shield.fontcolor || 'ffffff');
                    if (submission.shield.size) document.getElementById('badge5ySize').value = submission.shield.size;
                    if (submission.shield.border) document.getElementById('badge5yBorder').value = submission.shield.border;
                    if (submission.shield.barlen) document.getElementById('badge5yBarlen').value = submission.shield.barlen;
                    if (submission.shield.fontsize) document.getElementById('badge5yFontsize').value = submission.shield.fontsize;
                    if (submission.shield.barradius) document.getElementById('badge5yBarradius').value = submission.shield.barradius;
                    if (submission.shield.shadow !== undefined) document.getElementById('badge5yShadow').value = submission.shield.shadow;
                    if (submission.shield.anime !== undefined) document.getElementById('badge5yAnime').value = submission.shield.anime;
                }
                updateBadgePreview('5year');
                document.getElementById('activity3Form').style.display = 'block';
                document.getElementById('activity3Submission').style.display = 'none';
                document.querySelector('#activity3Form .btn').textContent = 'æ›´æ–°è®¾è®¡æ–¹æ¡ˆ';
                document.querySelector('#activity3Form .btn').onclick = () => updateSubmission('badge5year', articleId);
                document.getElementById('cancelBadge5yearBtn').style.display = 'inline-block';
                document.getElementById('activity3Form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit(activityKey) {
            if (activityKey === 'keyword') {
                // é‡ç½®è¡¨å•
                document.getElementById('keyword').value = '';
                document.getElementById('keywordDesc').value = '';
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                document.getElementById('keyword').classList.remove('error');
                document.getElementById('keywordDesc').classList.remove('error');
                document.getElementById('keywordError').classList.remove('show');
                document.getElementById('keywordDescError').classList.remove('show');
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.querySelector('#activity1Form .btn').textContent = 'æäº¤å…³é”®è¯';
                document.querySelector('#activity1Form .btn').onclick = submitKeyword;
                document.getElementById('cancelKeywordBtn').style.display = 'none';
                // æ˜¾ç¤ºæŠ•ç¨¿å†…å®¹ï¼Œéšè—è¡¨å•
                showForms();
            } else if (activityKey === 'badge2025') {
                // é‡ç½®è¡¨å•
                document.getElementById('badge2025Title').value = '';
                document.getElementById('badge2025Note').value = '';
                document.getElementById('badge2025Back').value = '#db5a6b';
                document.getElementById('badge2025Font').value = '#ffffff';
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                document.getElementById('badge2025Title').classList.remove('error');
                document.getElementById('badge2025TitleError').classList.remove('show');
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.querySelector('#activity2Form .btn').textContent = 'æäº¤é…è‰²æ–¹æ¡ˆ';
                document.querySelector('#activity2Form .btn').onclick = submitBadge2025;
                document.getElementById('cancelBadge2025Btn').style.display = 'none';
                // æ›´æ–°é¢„è§ˆ
                updateBadgePreview('2025');
                // æ˜¾ç¤ºæŠ•ç¨¿å†…å®¹ï¼Œéšè—è¡¨å•
                showForms();
            } else if (activityKey === 'badge5year') {
                // é‡ç½®è¡¨å•
                document.getElementById('badge5yTitle').value = '';
                document.getElementById('badge5yNote').value = '';
                document.getElementById('badge5yImageUpload').value = '';
                uploadedImageFile = null;
                document.getElementById('badge5yUrl').value = '';
                document.getElementById('badge5yUrl').placeholder = 'é»˜è®¤ä½¿ç”¨æ‚¨çš„å¤´åƒ';
                document.getElementById('badge5yBack').value = '#db5a6b';
                document.getElementById('badge5yFont').value = '#ffffff';
                // é‡ç½®é«˜çº§é€‰é¡¹
                document.getElementById('badge5ySize').value = '';
                document.getElementById('badge5yBorder').value = '';
                document.getElementById('badge5yBarlen').value = '';
                document.getElementById('badge5yFontsize').value = '';
                document.getElementById('badge5yBarradius').value = '';
                document.getElementById('badge5yShadow').value = '';
                document.getElementById('badge5yAnime').value = '';
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                document.getElementById('badge5yTitle').classList.remove('error');
                document.getElementById('badge5yTitleError').classList.remove('show');
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.querySelector('#activity3Form .btn').textContent = 'æäº¤è®¾è®¡æ–¹æ¡ˆ';
                document.querySelector('#activity3Form .btn').onclick = submitBadge5Year;
                document.getElementById('cancelBadge5yearBtn').style.display = 'none';
                // æ›´æ–°é¢„è§ˆ
                updateBadgePreview('5year');
                // æ˜¾ç¤ºæŠ•ç¨¿å†…å®¹ï¼Œéšè—è¡¨å•
                showForms();
            }
        }

        // æ›´æ–°æŠ•ç¨¿
        async function updateSubmission(activityKey, articleId) {
            if (activityKey === 'keyword') {
                await updateKeyword(articleId);
            } else if (activityKey === 'badge2025') {
                await updateBadge2025(articleId);
            } else if (activityKey === 'badge5year') {
                await updateBadge5Year(articleId);
            }
        }

        // æ›´æ–°å…³é”®è¯
        async function updateKeyword(articleId) {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†æ›´æ–°å…³é”®è¯')) {
                return;
            }

            const keywordValid = validateField('keyword', 'keywordError', 'è¯·è¾“å…¥å…³é”®è¯');
            const descValid = validateField('keywordDesc', 'keywordDescError', 'è¯·è¾“å…¥å…³é”®è¯ä»‹ç»');

            if (!keywordValid || !descValid) {
                return;
            }

            const keyword = document.getElementById('keyword').value.trim();
            const desc = document.getElementById('keywordDesc').value.trim();

            try {
                const response = await fetch(`/activity-api/shield-five-year/articles/${articleId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: keyword,
                        content: desc
                    })
                });

                if (response.ok) {
                    alert('å…³é”®è¯æ›´æ–°æˆåŠŸï¼');
                    document.getElementById('keyword').value = '';
                    document.getElementById('keywordDesc').value = '';
                    document.querySelector('#activity1Form .btn').textContent = 'æäº¤å…³é”®è¯';
                    document.querySelector('#activity1Form .btn').onclick = submitKeyword;
                    document.getElementById('cancelKeywordBtn').style.display = 'none';
                    await loadUserSubmissions();
                    showForms();
                    loadArticles('keyword', 'activity1Votes');
                } else {
                    const error = await response.json();
                    alert(error.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('æ›´æ–°å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ›´æ–°2025å¾½ç« é…è‰²
        async function updateBadge2025(articleId) {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†æ›´æ–°é…è‰²æ–¹æ¡ˆ')) {
                return;
            }

            const titleValid = validateField('badge2025Title', 'badge2025TitleError', 'è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜');

            if (!titleValid) {
                return;
            }

            const title = document.getElementById('badge2025Title').value.trim();
            const note = document.getElementById('badge2025Note').value.trim();
            const backcolor = document.getElementById('badge2025Back').value.substring(1);
            const fontcolor = document.getElementById('badge2025Font').value.substring(1);

            try {
                const submission = userSubmissions[ACTIVITY_IDS.badge2025];
                const shieldId = submission?.shieldId;

                // æ›´æ–°å¾½ç«  - ä½¿ç”¨ FormData
                if (shieldId) {
                    const formData = new FormData();
                    formData.append('articleId', articleId);
                    formData.append('backcolor', backcolor);
                    formData.append('fontcolor', fontcolor);
                    formData.append('title', title);
                    formData.append('note', note);

                    const shieldResponse = await fetch(`/activity-api/shield-five-year/shields/${shieldId}`, {
                        method: 'PATCH',
                        body: formData
                    });

                    if (!shieldResponse.ok) {
                        const error = await shieldResponse.json();
                        alert(error.message || 'å¾½ç« æ›´æ–°å¤±è´¥');
                        return;
                    }
                }

                // æ›´æ–°æ–‡ç« 
                const articleResponse = await fetch(`/activity-api/shield-five-year/articles/${articleId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: note || 'æˆ‘çš„2025å¾½ç« é…è‰²è®¾è®¡'
                    })
                });

                if (articleResponse.ok) {
                    alert('2025å¾½ç« é…è‰²æ›´æ–°æˆåŠŸï¼');
                    document.getElementById('badge2025Title').value = '';
                    document.getElementById('badge2025Note').value = '';
                    document.querySelector('#activity2Form .btn').textContent = 'æäº¤é…è‰²æ–¹æ¡ˆ';
                    document.querySelector('#activity2Form .btn').onclick = submitBadge2025;
                    document.getElementById('cancelBadge2025Btn').style.display = 'none';
                    await loadUserSubmissions();
                    showForms();
                    loadArticles('badge2025', 'activity2Votes');
                } else {
                    const error = await articleResponse.json();
                    alert(error.message || 'æ–‡ç« æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('æ›´æ–°å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ›´æ–°äº”å‘¨å²å¾½ç« è®¾è®¡
        async function updateBadge5Year(articleId) {
            if (!requireLogin('è¯·å…ˆç™»å½•åå†æ›´æ–°å¾½ç« è®¾è®¡')) {
                return;
            }

            const titleValid = validateField('badge5yTitle', 'badge5yTitleError', 'è¯·è¾“å…¥è®¾è®¡æ ‡é¢˜');

            if (!titleValid) {
                return;
            }

            const title = document.getElementById('badge5yTitle').value.trim();
            const note = document.getElementById('badge5yNote').value.trim();
            let url = document.getElementById('badge5yUrl').value;

            if (!uploadedImageFile && !url && currentUser && currentUser.avatar) {
                url = currentUser.avatar;
            }

            if (!uploadedImageFile && !url) {
                url = 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
            }

            const backcolor = document.getElementById('badge5yBack').value.substring(1);
            const fontcolor = document.getElementById('badge5yFont').value.substring(1);

            try {
                const submission = userSubmissions[ACTIVITY_IDS.badge5year];
                const shieldId = submission?.shieldId;

                // æ›´æ–°å¾½ç«  - ç»Ÿä¸€ä½¿ç”¨ FormData
                if (shieldId) {
                    const formData = new FormData();
                    formData.append('articleId', articleId);
                    formData.append('url', url);
                    formData.append('backcolor', backcolor);
                    formData.append('fontcolor', fontcolor);
                    formData.append('title', title);
                    formData.append('note', note);

                    // æ·»åŠ å¯é€‰å‚æ•°
                    const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                    optionalParams.forEach(param => {
                        const inputId = 'badge5y' + param.charAt(0).toUpperCase() + param.slice(1);
                        const value = document.getElementById(inputId).value;
                        if (value !== '') {
                            formData.append(param, value);
                        }
                    });

                    // å¦‚æœæœ‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ·»åŠ åˆ° FormData
                    if (uploadedImageFile) {
                        formData.append('img', uploadedImageFile);
                    }

                    const shieldResponse = await fetch(`/activity-api/shield-five-year/shields/${shieldId}`, {
                        method: 'PATCH',
                        body: formData
                    });

                    if (!shieldResponse.ok) {
                        const error = await shieldResponse.json();
                        alert(error.message || 'å¾½ç« æ›´æ–°å¤±è´¥');
                        return;
                    }
                }

                // æ›´æ–°æ–‡ç« 
                const articleResponse = await fetch(`/activity-api/shield-five-year/articles/${articleId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: note || 'æˆ‘çš„äº”å‘¨å²å¾½ç« è®¾è®¡'
                    })
                });

                if (articleResponse.ok) {
                    alert('äº”å‘¨å²å¾½ç« è®¾è®¡æ›´æ–°æˆåŠŸï¼' + (uploadedImageFile ? 'å›¾ç‰‡å·²ä¸Šä¼ ï¼Œåˆ·æ–°é¡µé¢å³å¯æŸ¥çœ‹æœ€ç»ˆæ•ˆæœã€‚' : ''));
                    document.getElementById('badge5yTitle').value = '';
                    document.getElementById('badge5yNote').value = '';
                    document.getElementById('badge5yImageUpload').value = '';
                    uploadedImageFile = null;
                    document.querySelector('#activity3Form .btn').textContent = 'æäº¤è®¾è®¡æ–¹æ¡ˆ';
                    document.querySelector('#activity3Form .btn').onclick = submitBadge5Year;
                    document.getElementById('cancelBadge5yearBtn').style.display = 'none';
                    await loadUserSubmissions();
                    showForms();
                    loadArticles('badge5year', 'activity3Votes');
                } else {
                    const error = await articleResponse.json();
                    alert(error.message || 'æ–‡ç« æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('æ›´æ–°å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
